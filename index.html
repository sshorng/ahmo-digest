<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>阿墨汐讀</title>
  <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/4475/4475622.png">
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');

    /* 台灣在地化與系統預設字體 */
    :root {
      --primary-font: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    body {
      font-family: var(--primary-font);

      background-color: #f8fafc;
      color: #1e293b;
      line-height: 1.6;
      letter-spacing: 0.015em;
    }

    .sidebar-item:hover {
      background-color: #f1f5f9;
    }

    /* 側欄同步圖示：預設隱藏，僅在 hover 時顯示 */
    .sidebar-sync-btn {
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .sidebar-item:hover .sidebar-sync-btn,
    .category-header:hover .sidebar-sync-btn {
      opacity: 1 !important;
    }

    .sidebar-item.active {
      background-color: #eff6ff;
      color: #2563eb;
    }

    .sidebar-item.active i {
      color: #3b82f6;
    }

    .category-header {
      display: flex;
      align-items: center;
      padding: 0.5rem 0.75rem;
      /* 標準化為 px-3 (0.75rem) */
      font-weight: 700;
      color: #334155;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .category-header i {
      width: 20px;
      margin-right: 8px;
      color: #64748b;
    }

    .category-header:hover {
      color: #1e293b;
    }

    .article-card:hover {
      border-color: #3b82f6;
      transform: translateY(-2px);
    }

    .article-card.is-read {
      opacity: 0.5;
      filter: grayscale(50%);
    }

    /* 效能優化：讓瀏覽器跳過渲染不在視窗內的內容 */
    .article-card,
    .list-view-item {
      content-visibility: auto;
      contain-intrinsic-size: 1px 250px;
      /* 提升渲染效率 */
      will-change: transform, opacity;
    }

    #podcast-player-bar {
      will-change: transform;
    }

    .marquee-track {
      will-change: transform;
    }

    .shimmer {
      background: linear-gradient(90deg, #f1f5f9 0%, #e2e8f0 50%, #f1f5f9 100%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0% {
        background-position: -200% 0;
      }

      100% {
        background-position: 200% 0;
      }
    }

    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 10px;
    }

    .modal {
      transition: opacity 0.25s ease;
    }

    body.modal-active {
      overflow: hidden;
    }

    .btn-icon {
      @apply p-2 rounded-lg transition-colors hover:bg-slate-100 text-slate-400;
    }

    /* --- Premium List View (Horizontal Card) --- */
    .list-view-item {
      display: flex !important;
      flex-direction: column !important;
      align-items: stretch !important;
      background-color: white !important;
      padding: 0.85rem 1rem !important;
      border-radius: 14px !important;
      border: 1px solid #f1f5f9 !important;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.02) !important;
      margin-bottom: 0.5rem !important;
      transition: all 0.2s ease !important;
      cursor: default !important;
      width: 100% !important;
    }

    #grid.is-list-mode {
      gap: 0 !important;
      background-color: transparent !important;
      border: none !important;
    }

    .item-summary {
      max-height: 0;
      overflow-y: auto;
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      opacity: 0;
      color: #334155;
      font-size: 0.875rem;
      line-height: 1.8 !important;
      padding-left: 1.5rem !important;
      /* 減少縮排，增加橫向空間 */
      padding-right: 1.5rem !important;
    }

    .list-view-item.is-expanded .item-summary {
      max-height: 600px;
      /* 限制展開高度並允許捲動 */
      opacity: 1;
      padding-top: 1rem;
      padding-bottom: 1.5rem;
      margin-top: 1rem;
      border-top: 1px dashed #f1f5f9;
    }

    /* 全文預覽優化：自動換行與防止橫向捲動 */
    .article-content-body {
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
      word-break: normal !important;
      overflow-x: hidden !important;
    }

    #modal-title {
      overflow-wrap: break-word !important;
      word-wrap: break-word !important;
      white-space: normal !important;
    }

    .article-content-body pre,
    .article-content-body code {
      white-space: pre-wrap !important;
      word-wrap: break-word !important;
    }

    .article-content-body img,
    .article-content-body video,
    .article-content-body iframe {
      max-width: 100% !important;
      height: auto !important;
    }

    .list-view-item:hover {
      border-color: #dbeafe !important;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.04) !important;
      transform: translateY(-2px);
    }

    .list-view-item.is-read {
      opacity: 0.5 !important;
      background-color: #fafafa !important;
      box-shadow: none !important;
    }

    .list-view-item .item-header {
      display: contents !important;
    }

    @media (min-width: 768px) {
      .list-view-item .item-header {
        grid-template-columns: auto auto 120px 1fr auto 60px 30px !important;
      }
    }

    .list-view-item .item-title-area {
      /* Remove flex from here as we use dynamic grid for children now */
      display: contents !important;
    }

    .list-view-item .item-title {
      font-size: 1.05rem !important;
      font-weight: 600 !important;
      color: #334155 !important;
      white-space: nowrap !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
      transition: color 0.2s !important;
    }

    .list-view-item .item-source-tag {
      font-size: 11px !important;
      font-weight: 700 !important;
      color: #3b82f6 !important;
      background-color: #eff6ff !important;
      padding: 0.25rem 0.5rem !important;
      border-radius: 6px !important;
      width: 120px !important;
      text-align: center !important;
      display: inline-block !important;
      white-space: nowrap !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
      transition: all 0.2s !important;
    }

    .list-view-item .item-source-tag:hover {
      background-color: #dbeafe !important;
    }

    .list-view-item .item-audio-actions {
      display: flex !important;
      align-items: center !important;
      gap: 0.5rem !important;
      justify-content: flex-end !important;
      width: 60px !important;
    }

    .list-view-item .item-meta-time {
      width: 60px !important;
      text-align: right !important;
      color: #94a3b8 !important;
      font-size: 12px !important;
      font-weight: 500 !important;
    }

    .list-view-item.is-expanded .item-title {
      color: #1e293b !important;
      white-space: normal !important;
    }

    .list-view-item .item-meta {
      display: contents !important;
      color: #94a3b8 !important;
      font-size: 11px !important;
    }


    .item-summary img {
      max-width: 100%;
      height: auto;
      border-radius: 12px;
      margin: 1.5rem 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .item-summary p {
      margin-bottom: 1.25rem;
    }

    /* 全文預覽彈窗 */
    #content-modal {
      transition: all 0.3s ease;
    }

    .modal-content-container {
      max-height: 80vh;
      overflow-y: auto;
    }

    .article-content-body {
      width: 100%;
      text-align: justify;
      color: #334155;
      font-size: 1.05rem;
      line-height: 1.8;
      letter-spacing: 0.01em;
    }

    .article-content-body p {
      margin-bottom: 1.5rem;
    }

    .article-content-body h1,
    .article-content-body h2,
    .article-content-body h3,
    .article-content-body h4,
    .article-content-body h5,
    .article-content-body h6 {
      color: #0f172a;
      font-weight: 700;
      line-height: 1.4;
      margin-top: 2rem;
      margin-bottom: 1rem;
    }

    .article-content-body h1 {
      font-size: 1.875rem;
    }

    .article-content-body h2 {
      font-size: 1.5rem;
      border-bottom: 2px solid #f1f5f9;
      padding-bottom: 0.5rem;
    }

    .article-content-body h3 {
      font-size: 1.25rem;
    }

    .article-content-body img {
      max-width: 100%;
      height: auto;
      border-radius: 12px;
      margin: 2rem auto;
      display: block;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      /* 處理損毀圖片：嘗試隱藏或顯示提示 */
      position: relative;
    }

    .article-content-body img::after {
      content: " [圖片無法顯示或已移除] ";
      display: block;
      font-size: 12px;
      color: #94a3b8;
      text-align: center;
      padding: 20px;
      background: #f8fafc;
      border-radius: 8px;
    }

    .article-content-body a {
      color: #2563eb;
      text-decoration: underline;
      text-underline-offset: 4px;
      transition: color 0.2s;
    }

    .article-content-body a:hover {
      color: #1d4ed8;
    }

    .article-content-body blockquote {
      border-left: 4px solid #3b82f6;
      background-color: #f8fafc;
      padding: 1.25rem 1.5rem;
      margin: 1.5rem 0;
      border-radius: 0 12px 12px 0;
      font-style: italic;
      color: #475569;
    }

    .article-content-body ul,
    .article-content-body ol {
      margin-bottom: 1.5rem;
      padding-left: 1.5rem;
    }

    .article-content-body ul {
      list-style-type: disc;
    }

    .article-content-body ol {
      list-style-type: decimal;
    }

    .article-content-body li {
      margin-bottom: 0.5rem;
    }

    .article-content-body code {
      background-color: #f1f5f9;
      padding: 0.2rem 0.4rem;
      border-radius: 6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.9em;
      color: #0f172a;
    }

    .article-content-body pre {
      background-color: #1e293b;
      color: #f8fafc;
      padding: 1.5rem;
      border-radius: 12px;
      overflow-x: auto;
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
      line-height: 1.6;
    }

    .article-content-body pre code {
      background-color: transparent;
      padding: 0;
      color: inherit;
    }

    .article-content-body hr {
      border: 0;
      border-top: 2px solid #f1f5f9;
      margin: 2.5rem 0;
    }

    .article-content-body table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
    }

    .article-content-body th,
    .article-content-body td {
      border: 1px solid #e2e8f0;
      padding: 0.75rem;
      text-align: left;
    }

    .article-content-body th {
      background-color: #f8fafc;
      font-weight: 600;
    }

    /* 強制 RSS 原始 HTML 內容撐開寬度 */
    .article-content-body div,
    .article-content-body table {
      max-width: 100% !important;
      width: auto !important;
    }


    .link-btn {
      width: 24px !important;
      height: 24px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      border-radius: 6px !important;
      background-color: #f8fafc !important;
      color: #cbd5e1 !important;
      transition: all 0.2s !important;
      cursor: pointer !important;
    }

    .link-btn:hover {
      background-color: #eff6ff !important;
      color: #3b82f6 !important;
    }

    .unread-dot {
      width: 6px !important;
      height: 6px !important;
      background-color: #3b82f6 !important;
      border-radius: 50% !important;
      flex-shrink: 0 !important;
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.5) !important;
    }

    /* Global Podcast Player Bar */
    #podcast-player-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border-top: 1px solid rgba(0, 0, 0, 0.05);
      z-index: 110;
      box-shadow: 0 -10px 40px -10px rgba(0, 0, 0, 0.08);
      padding: 0.75rem 1.5rem;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    #podcast-player-bar.player-hidden {
      transform: translateY(120%);
    }

    /* Floating Ball State */
    #podcast-floating-ball {
      position: fixed;
      bottom: 2rem;
      right: 1.5rem;
      width: 56px;
      height: 56px;
      border-radius: 28px;
      background: #3b82f6;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.5);
      z-index: 105;
      opacity: 0;
      pointer-events: none;
      transform: scale(0.5);
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    #podcast-floating-ball.show {
      opacity: 1;
      pointer-events: auto;
      transform: scale(1);
    }

    #podcast-floating-ball .playing-anim {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 3px solid #3b82f6;
      animation: ball-pulse 2s infinite;
    }

    @keyframes ball-pulse {
      0% {
        transform: scale(1);
        opacity: 0.8;
      }

      100% {
        transform: scale(1.6);
        opacity: 0;
      }
    }

    .player-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    /* --- Custom Range Input (Progress Bar) --- */
    .progress-container {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    .time-display {
      font-size: 10px;
      font-weight: 600;
      color: #94a3b8;
      font-family: ui-monospace, SFMono-Regular, monospace;
      min-width: 35px;
    }

    .progress-bar-wrap {
      flex: 1;
      height: 4px;
      background: #e2e8f0;
      border-radius: 2px;
      position: relative;
      cursor: pointer;
    }

    .custom-progress {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 30px;
      background: transparent;
      outline: none;
      margin: 0;
      position: absolute;
      top: 50%;
      left: 0;
      transform: translateY(-50%);
      z-index: 5;
      cursor: pointer;
    }

    .custom-progress::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      background: #3b82f6;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.4);
      border: 2px solid white;
      transition: transform 0.2s;
    }

    .custom-progress::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    .progress-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: #3b82f6;
      border-radius: 2px;
      pointer-events: none;
      width: 0%;
      z-index: 1;
    }

    /* Main Play/Pause Big Button */
    .main-play-btn {
      width: 44px;
      height: 44px;
      background: #3b82f6;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .main-play-btn:hover {
      transform: scale(1.05);
      background: #2563eb;
    }

    .main-play-btn:active {
      transform: scale(0.95);
    }

    .playback-main-group {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      order: 1;
    }

    .player-info-plus-controls {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      min-width: 0;
      flex: 1.5;
      order: 2;
    }

    .player-meta-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
      flex: 1;
      order: 1;
    }

    .player-info {
      flex: 1;
      min-width: 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      text-align: left;
    }

    .player-title-wrap {
      overflow: hidden;
      width: 100%;
      position: relative;
    }

    .player-title {
      font-size: 0.9rem;
      font-weight: 700;
      color: #1e293b;
      white-space: nowrap;
      display: flex;
      width: max-content;
    }

    .marquee-span {
      padding-right: 60px;
      display: inline-block;
    }

    .player-title.animating {
      animation: player-marquee 20s linear infinite;
    }

    @keyframes player-marquee {
      0% {
        transform: translateX(0);
      }

      100% {
        transform: translateX(-50%);
      }
    }

    /* 滑鼠懸停時暫停滾動以便閱讀 */
    .player-title-wrap:hover .player-title {
      animation-play-state: paused;
    }

    .player-info-plus-controls {
      display: contents;
    }

    .player-controls {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      order: 3;
      white-space: nowrap;
    }

    .player-all-controls-group {
      display: contents;
    }

    .audio-main-el {
      height: 32px;
      flex: 1;
      min-width: 100px;
      max-width: 800px;
      border-radius: 8px;
    }

    /* Speed Menu */
    .speed-menu-container {
      position: relative;
    }

    #speed-menu {
      position: absolute;
      bottom: calc(100% + 15px);
      left: 50%;
      transform: translateX(-50%) translateY(10px);
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
      padding: 0.4rem;
      display: flex;
      flex-direction: column;
      gap: 2px;
      opacity: 0;
      pointer-events: none;
      transition: all 0.2s ease;
      z-index: 130;
      min-width: 80px;
    }

    #speed-menu.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(-50%) translateY(0);
    }

    .speed-menu-item {
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 600;
      color: #64748b;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
      text-align: center;
    }

    .speed-menu-item:hover {
      background: #f1f5f9;
      color: #3b82f6;
    }

    .speed-menu-item.active {
      background: #eff6ff;
      color: #3b82f6;
    }

    .skip-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #94a3b8;
      cursor: pointer;
      border-radius: 50%;
      transition: all 0.2s;
    }

    .skip-btn:hover {
      background: #f1f5f9;
      color: #3b82f6;
    }

    body.theme-dark .skip-btn:hover,
    body.theme-midnight .skip-btn:hover {
      background: #334155;
    }

    body.theme-dark #speed-menu,
    body.theme-midnight #speed-menu {
      background: #1e293b;
      border-color: #334155;
    }

    body.theme-dark .speed-menu-item:hover,
    body.theme-midnight .speed-menu-item:hover {
      background: #334155;
    }

    body.theme-dark .speed-menu-item.active,
    body.theme-midnight .speed-menu-item.active {
      background: #334155;
      color: #3b82f6;
    }

    /* Queue Panel */
    #queue-panel {
      position: absolute;
      bottom: 100%;
      right: 1.5rem;
      width: 320px;
      max-height: 400px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 16px 16px 4px 4px;
      margin-bottom: 0.5rem;
      box-shadow: 0 -10px 40px -10px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      opacity: 0;
      pointer-events: none;
      transform: translateY(10px);
      transition: all 0.3s ease;
    }

    #queue-panel.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    .queue-header {
      padding: 1rem;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .queue-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }

    .queue-item {
      padding: 0.75rem;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      border-bottom: 1px solid #f1f5f9;
    }

    .queue-item:hover {
      background: #f1f5f9;
    }

    .queue-item.active {
      background: #eff6ff;
      border-color: #dbeafe;
    }

    /* Dark Mode Player */
    body.theme-dark #podcast-player-bar,
    body.theme-midnight #podcast-player-bar {
      background: rgba(15, 23, 42, 0.98);
      border-color: #334155;
    }

    body.theme-dark .player-title,
    body.theme-midnight .player-title {
      color: #f1f5f9;
    }

    body.theme-dark .speed-selector,
    body.theme-midnight .speed-selector {
      background: #1e293b;
    }

    body.theme-dark .speed-btn.active,
    body.theme-midnight .speed-btn.active {
      background: #334155;
      color: white;
    }

    body.theme-dark #queue-panel,
    body.theme-midnight #queue-panel {
      background: #0f172a;
      border-color: #334155;
      color: #f1f5f9;
    }

    body.theme-dark .queue-header,
    body.theme-midnight .queue-header {
      background: #1e293b;
      border-color: #334155;
    }

    body.theme-dark .queue-item:hover,
    body.theme-midnight .queue-item:hover {
      background: #1e293b;
    }

    body.theme-dark .queue-item.active,
    body.theme-midnight .queue-item.active {
      background: #1e293b;
      border-color: #3b82f6;
    }

    /* Cards/List Play Icons */
    .audio-action-btn {
      padding: 0.4rem;
      border-radius: 8px;
      transition: all 0.2s;
      color: #64748b;
    }

    .audio-action-btn:hover {
      background: #eff6ff;
      color: #3b82f6;
      transform: scale(1.1);
    }

    /* --- Toast Notification --- */
    #toast-container {
      position: fixed;
      bottom: 6rem;
      right: 2rem;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .toast {
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* 處理影片與嵌入內容 */
    .article-content-body iframe,
    .article-content-body embed,
    .article-content-body video {
      max-width: 100%;
      border-radius: 12px;
      margin: 1.5rem 0;
      display: block;
    }

    /* 隱藏追蹤像素 */
    .article-content-body img[width="1"],
    .article-content-body img[height="1"],
    .article-content-body img[style*="width:1px"],
    .article-content-body img[style*="height:1px"] {
      display: none !important;
    }

    /* 文字內容最大寬度與居中 - 提升閱讀舒適度 */
    #modal-body-text>* {
      max-width: 750px;
      margin-left: auto;
      margin-right: auto;
    }

    /* --- Mobile Responsive Optimizations --- */
    @media (max-width: 640px) {
      .list-view-item .item-header {
        display: flex !important;
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 0.5rem !important;
      }

      .list-view-item .item-header>* {
        width: 100% !important;
        text-align: left !important;
        justify-content: flex-start !important;
      }

      .list-view-item .item-title {
        white-space: normal !important;
        font-size: 1rem !important;
      }

      .list-view-item .item-meta-time,
      .list-view-item .item-source-tag {
        width: auto !important;
        max-width: none !important;
      }

      .list-view-item .item-audio-actions {
        justify-content: flex-start !important;
      }

      .list-view-item .item-meta {
        font-size: 10px !important;
        gap: 0.5rem !important;
        flex-wrap: wrap;
      }

      .list-view-item .item-title {
        font-size: 0.9rem !important;
        white-space: normal !important;
        line-clamp: 2;
        display: -webkit-box;
        -webkit-box-orient: vertical;
      }

      .article-content-body {
        font-size: 0.95rem !important;
        line-height: 1.6 !important;
      }

      .modal-content-container {
        padding: 1.25rem !important;
      }

      #content-area {
        padding: 0.75rem !important;
      }

      /* Mobile Podcast Player (極簡單排優化) */
      #podcast-player-bar {
        padding: 4px 12px 6px 12px;
        /* 極度壓縮高度 */
        height: 60px;
        /* 固定高度 */
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      #podcast-player-bar .player-content {
        display: grid !important;
        grid-template-columns: 1.2fr 1fr 1fr;
        /* 左(資訊) 中(播放) 右(功能) */
        align-items: center;
        gap: 0;
        width: 100%;
      }

      /* 1. 資訊區 (左側) */
      .player-meta-group {
        order: 1;
        width: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 1px !important;
        overflow: hidden;
      }

      .player-info {
        max-width: 100%;
      }

      .player-title {
        font-size: 13px;
        color: #1e293b;
        font-weight: 700;
        white-space: nowrap;
      }

      .player-subtitle {
        font-size: 10px;
        color: #3b82f6 !important;
        font-weight: 700;
        margin: 0 !important;
      }

      /* 2. 進度條 (置頂細線) */
      .progress-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100% !important;
        height: 3px !important;
        padding: 0 !important;
        margin: 0 !important;
        display: block !important;
      }

      .progress-container .time-display {
        display: none !important;
        /* 單排模式隱藏時間數字 */
      }

      .progress-bar-wrap {
        height: 100% !important;
        border-radius: 0 !important;
        background: rgba(0, 0, 0, 0.05) !important;
      }

      .progress-fill {
        border-radius: 0 !important;
      }

      .custom-progress {
        height: 10px !important;
        top: 0 !important;
        transform: none !important;
      }

      /* 3. 按鈕區 (居中與右側) */
      .player-all-controls-group {
        display: contents !important;
        /* 讓子節點參與外層 Grid */
      }

      .playback-main-group {
        grid-column: 2;
        justify-self: center;
        display: flex !important;
        gap: 12px !important;
      }

      .player-controls-left {
        display: none !important;
        /* 手機版左側功能與資訊重疊，移到右側 */
      }

      .player-controls-right {
        grid-column: 3;
        justify-self: end;
        display: flex !important;
        gap: 6px !important;
      }

      /* 手機版按鈕尺寸極大化壓縮 */
      .main-play-btn {
        width: 38px;
        height: 38px;
        font-size: 14px;
        box-shadow: none;
      }

      .playback-main-group button i {
        font-size: 12px;
      }

      .player-controls-right button,
      .speed-menu-container button {
        width: 28px !important;
        height: 28px !important;
        background: transparent !important;
      }

      button#player-download-btn {
        display: none !important;
        /* 徹底移除手機下載 */
      }

      .skip-btn {
        width: 40px;
        height: 40px;
        font-size: 18px;
      }

      .main-play-btn {
        width: 50px;
        height: 50px;
        font-size: 22px;
      }
    }

    /* --- Theme: Warm (Soft Paper) --- */
    body.theme-warm {
      background-color: #faf8f5;
      color: #433e38;
    }

    body.theme-warm .bg-white,
    body.theme-warm .bg-slate-50,
    body.theme-warm #content-area {
      background-color: #ffffff !important;
      border-color: #efedea !important;
    }

    body.theme-warm .bg-slate-100 {
      background-color: #f7f5f2 !important;
    }

    body.theme-warm .text-blue-600,
    body.theme-warm .text-blue-500 {
      color: #b45309 !important;
    }

    body.theme-warm .bg-blue-600,
    body.theme-warm .bg-blue-500,
    body.theme-warm #unread-dot-indicator {
      background-color: #b45309 !important;
    }

    body.theme-warm .sidebar-item.active {
      background-color: #f7f5f2 !important;
      color: #b45309 !important;
    }

    body.theme-warm #modal-body-text {
      background-color: #ffffff !important;
      color: #433e38 !important;
    }

    /* --- Theme: Dark (Slate Modern) --- */
    body.theme-dark {
      background-color: #0c0c0e;
      color: #a1a1aa;
    }

    body.theme-dark #sidebar,
    body.theme-dark header,
    body.theme-dark [class*="bg-white"],
    body.theme-dark [class*="bg-slate-50"] {
      background-color: #121216 !important;
      border-color: #1e1e24 !important;
      box-shadow: none !important;
    }

    body.theme-dark #content-area,
    body.theme-dark #modal-body-text,
    body.theme-dark .article-card {
      background-color: #0c0c0e !important;
      border-color: #1e1e24 !important;
      box-shadow: none !important;
    }

    body.theme-dark .bg-slate-100 {
      background-color: #14141a !important;
    }

    body.theme-dark .text-slate-800,
    body.theme-dark .text-slate-700 {
      color: #f1f5f9 !important;
    }

    body.theme-dark .text-blue-500,
    body.theme-dark .text-blue-600 {
      color: #8b5cf6 !important;
    }

    body.theme-dark .bg-blue-600,
    body.theme-dark .bg-blue-500,
    body.theme-dark #unread-dot-indicator {
      background-color: #6366f1 !important;
      color: #fff !important;
      box-shadow: none !important;
    }

    body.theme-dark .sidebar-item.active {
      background-color: #1e1e24 !important;
      color: #f8fafc !important;
      border: 1px solid #4f46e5;
    }

    body.theme-dark .article-card:hover {
      border-color: #4f46e5 !important;
      background-color: #121216 !important;
      transform: none !important;
    }

    body.theme-dark #search-pill,
    body.theme-dark #mobile-search-bar {
      background-color: #121216 !important;
      border-color: #1e1e24 !important;
    }

    body.theme-dark #search-input {
      color: #f1f5f9 !important;
    }

    body.theme-dark .unread-dot {
      background-color: #6366f1 !important;
      box-shadow: none !important;
      animation: none !important;
    }

    body.theme-dark .article-card.is-read {
      opacity: 0.35;
      filter: grayscale(1);
    }

    body.theme-dark .category-header {
      color: #4b5563 !important;
      border-bottom: 1px solid #1e1e24 !important;
    }

    body.theme-dark .category-header i {
      color: #4f46e5 !important;
    }

    body.theme-dark .text-slate-400,
    body.theme-dark .text-slate-300 {
      color: #64748b !important;
    }

    body.theme-dark ::-webkit-scrollbar-thumb {
      background: #334155 !important;
    }

    /* --- Theme: Midnight (Ebony Elegant) --- */
    body.theme-midnight {
      background-color: #000000;
      color: #71717a;
    }

    body.theme-midnight #sidebar,
    body.theme-midnight header,
    body.theme-midnight [class*="bg-white"],
    body.theme-midnight [class*="bg-slate-50"] {
      background-color: #080808 !important;
      border-color: #1a1a1a !important;
      box-shadow: none !important;
    }

    body.theme-midnight #content-area,
    body.theme-midnight #modal-body-text,
    body.theme-midnight .article-card {
      background-color: #000000 !important;
      border-color: #111111 !important;
      box-shadow: none !important;
    }

    body.theme-midnight .bg-slate-100 {
      background-color: #050505 !important;
    }

    body.theme-midnight .text-slate-800,
    body.theme-midnight .text-slate-700 {
      color: #d4d4d8 !important;
    }

    body.theme-midnight .text-blue-500,
    body.theme-midnight .text-blue-600 {
      color: #a1a1aa !important;
    }

    body.theme-midnight .bg-blue-600,
    body.theme-midnight .bg-blue-500,
    body.theme-midnight #unread-dot-indicator {
      background-color: #18181b !important;
      color: #ffffff !important;
      box-shadow: none !important;
    }

    body.theme-midnight .sidebar-item.active {
      background-color: #0f0f0f !important;
      color: #ffffff !important;
      border: 1px solid #27272a;
    }

    body.theme-midnight .article-card:hover {
      border-color: #3f3f46 !important;
      background-color: #080808 !important;
      transform: none !important;
    }

    body.theme-midnight #search-pill,
    body.theme-midnight #mobile-search-bar {
      background-color: #080808 !important;
      border-color: #1a1a1a !important;
    }

    body.theme-midnight #search-input {
      color: #ffffff !important;
    }

    body.theme-midnight .unread-dot {
      background-color: #27272a !important;
      box-shadow: none !important;
      animation: none !important;
    }

    body.theme-midnight .article-card.is-read {
      opacity: 0.3;
      filter: grayscale(1);
    }

    body.theme-midnight .category-header {
      color: #27272a !important;
      border-bottom: 1px solid #111111 !important;
    }

    body.theme-midnight .category-header i {
      color: #18181b !important;
    }

    body.theme-midnight .text-slate-400,
    body.theme-midnight .text-slate-300 {
      color: #3f3f46 !important;
    }


    /* --- AI Tab System --- */
    .tab-btn {
      @apply px-4 py-2 text-sm font-medium transition-all border-b-2;
    }

    .tab-btn.active {
      @apply border-blue-500 text-blue-600;
    }

    .tab-btn.inactive {
      @apply border-transparent text-slate-400 hover:text-slate-600;
    }

    .ai-sparkle-btn {
      @apply text-amber-400 hover:text-amber-500 transition-colors transform hover:scale-110 active:scale-95 grayscale hover:grayscale-0;
    }

    .ai-sparkle-btn.active {
      @apply animate-pulse grayscale-0;
    }

    /* --- Content Modal Toggle --- */
    .pill-toggle-container {
      display: flex;
      align-items: center;
      background-color: #f1f5f9;
      padding: 2px;
      border-radius: 9999px;
      border: 1px solid #e2e8f0;
    }

    .pill-toggle-btn {
      padding: 0.25rem 0.75rem;
      font-size: 10px;
      font-weight: 700;
      transition: all 0.2s ease;
      border-radius: 9999px;
    }

    .pill-toggle-btn.active {
      background-color: white;
      color: #2563eb;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .pill-toggle-btn.inactive {
      color: #94a3b8;
    }

    .pill-toggle-btn.inactive:hover {
      color: #64748b;
    }

    /* AI Note Content Styling Overrides */
    #content-summary.prose {
      color: #334155;
    }

    #content-summary.prose h2 {
      color: #1e293b;
      font-size: 1.25rem;
      border-bottom: 2px solid #eff6ff;
      padding-bottom: 0.25rem;
      margin-top: 2rem;
    }

    #content-summary.prose h3 {
      color: #334155;
      font-size: 1.05rem;
      margin-top: 1.5rem;
    }

    #content-summary.prose strong {
      color: #2563eb;
    }

    #content-summary.prose blockquote {
      border-left-color: #3b82f6;
      background-color: #f8fafc;
      color: #475569;
      font-style: normal;
      border-radius: 0 8px 8px 0;
    }

    #content-summary.prose p {
      margin-bottom: 1rem;
    }

    body.theme-midnight .pill-toggle-container {
      background-color: #0f0f0f;
      border-color: #27272a;
    }

    body.theme-midnight .pill-toggle-btn.active {
      background-color: #27272a;
      color: #ffffff;
    }

    .loading-spinner {
      display: inline-block;
      vertical-align: middle;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #3498db;
      border-radius: 50%;
      width: 14px;
      height: 14px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    body.theme-midnight .tab-btn.inactive {
      color: #3f3f46 !important;
    }

    body.theme-midnight .tab-btn.active {
      border-color: #3f3f46 !important;
      color: #ffffff !important;
    }

    body.theme-midnight .ai-sparkle-btn {
      filter: grayscale(1) opacity(0.5);
    }

    body.theme-midnight .ai-sparkle-btn:hover {
      filter: none opacity(1);
    }

    ::-webkit-scrollbar-thumb {
      background: #1a1a1a !important;
    }

    /* --- Pull to Refresh --- */
    .ptr-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      pointer-events: none;
      z-index: 10;
      opacity: 0;
      transform: translateY(-100%);
      transition: opacity 0.3s, transform 0.3s;
    }

    .ptr-container.active {
      opacity: 1;
      transform: translateY(0);
    }

    .ptr-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #3b82f6;
      font-size: 14px;
      transition: transform 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    }

    .ptr-icon i {
      transition: transform 0.2s;
    }

    .ptr-container.pulling .ptr-icon i {
      transform: rotate(var(--ptr-rotate, 0deg));
    }

    .ptr-container.refreshing .ptr-icon i {
      animation: spin 1s linear infinite;
    }

    #content-area {
      transition: transform 0.15s ease-out;
    }
  </style>
</head>

<body class="h-screen flex overflow-hidden">
  <div id="toast-container"></div>

  <!-- Mobile Sidebar Overlay -->
  <div id="sidebar-overlay" onclick="toggleSidebar(false)"
    class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-30 opacity-0 pointer-events-none transition-opacity md:hidden">
  </div>

  <!-- 側邊欄 (Mobile: Drawer mode, Desktop: Statis mode) -->
  <aside id="sidebar"
    class="fixed inset-y-0 left-0 z-40 w-72 bg-white border-r border-slate-200 transform -translate-x-full transition-transform duration-300 md:translate-x-0 md:static md:flex md:flex-col md:w-64 md:shrink-0 h-full flex flex-col shadow-2xl md:shadow-none">
    <div class="px-6 pt-8 pb-6 flex flex-col space-y-4">
      <div class="flex items-center justify-between">
        <a id="logo-link" href="#" target="_blank" class="flex items-center space-x-3 group cursor-pointer">
          <div
            class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-100 group-hover:scale-105 transition-transform duration-300">
            <i class="fa-solid fa-rss text-white text-lg"></i>
          </div>
          <div class="flex flex-col">
            <h1
              class="text-xl font-black bg-clip-text text-transparent bg-gradient-to-r from-blue-600 via-blue-700 to-indigo-700 tracking-tight leading-none">
              阿墨汐讀
            </h1>
            <span
              class="text-[9px] font-bold text-slate-400 uppercase tracking-[0.25em] mt-1.5 ml-0.5 whitespace-nowrap">Ahmo
              Digest</span>
          </div>
        </a>

        <div class="flex items-center space-x-1">
          <button onclick="showSettings()"
            class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 hover:text-blue-600 hover:bg-blue-50 transition-all"
            title="系統設定">
            <i class="fa-solid fa-cog text-sm"></i>
          </button>
          <button onclick="toggleSidebar(false)"
            class="md:hidden w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-all">
            <i class="fa-solid fa-xmark text-lg"></i>
          </button>
        </div>
      </div>
    </div>


    <nav class="flex-1 flex flex-col px-4 min-h-0">
      <!-- Top Actions -->
      <div class="space-y-1 mb-8">
        <button onclick="toggleManager(true)"
          class="w-full flex items-center space-x-3 px-4 py-3 rounded-xl bg-blue-600 text-white font-bold shadow-lg shadow-blue-100 hover:bg-blue-700 transition-all mb-4">
          <i class="fa-solid fa-plus-circle text-lg"></i>
          <span>新增訂閱源</span>
        </button>

        <button id="all-articles-btn" onclick="resetFilters()"
          class="sidebar-item w-full flex items-center justify-between px-4 py-2.5 text-sm font-medium rounded-xl transition-all active">
          <div class="flex items-center space-x-3">
            <i class="fa-solid fa-layer-group w-5 text-blue-500"></i>
            <span>全部文章</span>
          </div>
          <span id="all-articles-count"
            class="px-1.5 py-0.5 bg-blue-100 text-blue-600 text-[10px] font-bold rounded-md font-mono"></span>
        </button>

        <button id="star-filter-btn" onclick="setReadLaterFilter()"
          class="sidebar-item w-full flex items-center justify-between px-4 py-2.5 text-sm font-medium rounded-xl transition-all">
          <div class="flex items-center space-x-3">
            <i class="fa-solid fa-star w-5 text-amber-400"></i>
            <span>稍候閱讀</span>
          </div>
          <span id="star-articles-count"
            class="px-1.5 py-0.5 bg-amber-50 text-amber-600 text-[10px] font-bold rounded-md font-mono"></span>
        </button>
      </div>

      <div class="flex-shrink-0 mb-4 flex items-center justify-between px-2">
        <h2 class="text-xs font-semibold text-slate-400 uppercase tracking-wider">我的訂閱</h2>
        <button onclick="toggleManager(true)" class="text-slate-400 hover:text-blue-600 transition-colors"
          title="管理訂閱來源">
          <i class="fa-solid fa-gear text-xs"></i>
        </button>
      </div>
      <div id="category-list" class="flex-1 overflow-y-auto space-y-1 pr-1 pb-4">
        <div class="p-2 text-xs text-slate-400 animate-pulse">載入中...</div>
      </div>
    </nav>

    <div id="sync-container"
      class="p-4 border-t border-slate-100 flex items-center justify-center space-x-2 text-[10px] text-slate-400">
      <button id="manual-cache-btn" onclick="handleManualCache()" class="hover:text-blue-600 transition-colors">
        <i id="cache-icon" class="fa-solid fa-cloud-arrow-down text-xs"></i>
      </button>
      <div id="sync-status-area" class="flex items-center space-x-1">
        <span>最後同步: <span id="last-update" class="font-medium text-slate-500">載入中...</span></span>
        <button onclick="clearPendingSync()" class="text-slate-300 hover:text-amber-500 px-1" title="清除中斷符號">
          <i class="fa-solid fa-broom text-[8px]"></i>
        </button>
      </div>
    </div>
  </aside>

  <!-- 主要內容區 -->
  <main class="flex-1 flex flex-col min-w-0 overflow-hidden w-full relative">

    <!-- Mobile Search Bar Overlay (Hidden by default) -->
    <div id="mobile-search-bar"
      class="w-full bg-white border-b border-slate-200 p-2 absolute top-16 left-0 z-30 shadow-md hidden transition-all">
      <div class="relative">
        <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
        <input id="mobile-search-input" type="text" placeholder="搜尋文章..." oninput="handleSearch(this.value)"
          class="w-full pl-10 pr-10 py-2 bg-slate-100 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500/20 focus:bg-white transition-all">
        <button onclick="toggleMobileSearch()" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
    </div>

    <header
      class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-3 md:px-8 z-20 sticky top-0 gap-2">
      <div class="flex items-center space-x-3 shrink-0">
        <!-- Menu Button for Mobile -->
        <button onclick="toggleSidebar(true)" class="md:hidden p-2 -ml-2 text-slate-500 hover:bg-slate-100 rounded-lg">
          <i class="fa-solid fa-bars text-lg"></i>
        </button>
        <div class="flex flex-col min-w-0 pr-2">
          <h2 id="view-title" class="text-sm md:text-lg font-bold text-slate-800 truncate max-w-[150px] md:max-w-none">
            最近文章</h2>
          <div class="flex items-center space-x-2 h-6 text-slate-400">
            <span id="article-count"
              class="text-[10px] md:text-[11px] font-medium whitespace-nowrap leading-none pt-0.5">更新中...</span>
            <div id="view-actions" class="flex items-center space-x-1.5 h-full"></div>
          </div>
        </div>
      </div>

      <!-- Search & Central Controls -->
      <div class="hidden md:flex flex-1 items-center justify-center max-w-2xl mx-auto px-4 lg:px-6">
        <div id="search-pill"
          class="flex items-center w-full bg-slate-100 rounded-2xl p-1 shadow-sm border border-slate-200/50">
          <!-- Search Box -->
          <div class="relative flex-1 group">
            <i
              class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-blue-500 transition-colors"></i>
            <input id="search-input" type="text" placeholder="搜尋文章..." oninput="handleSearch(this.value)"
              class="w-full pl-11 pr-2 py-2.5 bg-transparent border-none text-sm outline-none focus:ring-0">
          </div>

          <!-- Central Actions (Condensed) -->
          <div class="flex items-center space-x-1 px-1 whitespace-nowrap">
            <button onclick="refreshAll()"
              class="p-2 text-slate-500 hover:text-blue-600 hover:bg-white rounded-xl transition-all flex items-center justify-center min-w-[36px]"
              title="重新整理">
              <i id="refresh-icon" class="fa-solid fa-rotate-right text-sm"></i>
            </button>
            <button onclick="markPageAsRead()"
              class="p-2 text-slate-500 hover:text-blue-600 hover:bg-white rounded-xl transition-all flex items-center justify-center min-w-[36px]"
              title="全部已讀">
              <i class="fa-solid fa-check-double text-sm"></i>
            </button>
            <div class="w-px h-4 bg-slate-300 mx-1 opacity-40"></div>
            <button id="unread-toggle" onclick="toggleUnreadFilter()"
              class="flex items-center space-x-2 px-3 py-1.5 text-slate-500 hover:bg-white rounded-xl transition-all"
              title="隱藏已讀">
              <i class="fa-solid fa-eye-slash text-sm"></i>
              <span id="unread-dot-indicator"
                class="w-1.5 h-1.5 rounded-full bg-blue-500 transition-opacity opacity-20 shadow-none"></span>
            </button>
          </div>
        </div>
      </div>

      <div class="flex items-center space-x-1 md:space-x-3">
        <!-- Style & View Group (Right side) -->
        <div
          class="hidden md:flex items-center space-x-1 lg:space-x-2 bg-slate-50 p-1 rounded-xl border border-slate-100">
          <button id="theme-btn" onclick="cycleTheme()"
            class="p-2 text-slate-500 hover:text-indigo-600 rounded-lg hover:bg-white transition-all" title="切換佈景主題">
            <i class="fa-solid fa-palette text-sm"></i>
          </button>
          <div class="w-px h-4 bg-slate-200 mx-1"></div>
          <button id="display-mode-toggle" onclick="toggleDisplayMode()"
            class="p-2 rounded-lg transition-all text-slate-500 hover:text-indigo-600 hover:bg-white" title="切換顯示模式">
            <i id="display-mode-icon" class="fa-solid fa-grip text-sm"></i>
          </button>
        </div>

        <!-- Mobile Buttons -->
        <div class="md:hidden flex items-center space-x-0.5">
          <button onclick="toggleMobileSearch()" class="p-2 text-slate-500" title="搜尋"><i
              class="fa-solid fa-magnifying-glass text-sm"></i></button>
          <button id="mobile-display-toggle" onclick="toggleDisplayMode()" class="p-2 text-slate-500" title="切換顯示模式">
            <i class="mobile-display-icon fa-solid fa-grip text-sm"></i>
          </button>
          <button onclick="cycleTheme()" class="p-2 text-slate-500" title="切換佈景主題"><i
              class="fa-solid fa-palette text-sm"></i></button>
          <button onclick="refreshAll()" class="p-2 text-slate-500" title="重新整理"><i id="mobile-refresh-icon"
              class="fa-solid fa-rotate text-sm"></i></button>
          <div class="w-px h-4 bg-slate-300 mx-0.5 opacity-30"></div>
          <button onclick="markPageAsRead()" class="p-2 text-slate-500" title="全部已讀"><i
              class="fa-solid fa-check-double text-sm"></i></button>
          <button onclick="toggleUnreadFilter()" class="p-2 text-slate-500" title="篩選未讀"><i
              class="fa-solid fa-eye-slash text-sm"></i></button>
        </div>
      </div>
    </header>

    <section id="content-area" class="flex-1 overflow-y-auto bg-slate-50/50 p-4 md:p-10 relative">
      <!-- Pull to Refresh Indicator -->
      <div id="ptr-indicator" class="ptr-container">
        <div class="ptr-icon">
          <i class="fa-solid fa-arrow-down"></i>
        </div>
      </div>

      <div id="loader" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
        <div class="bg-white p-6 rounded-2xl border border-slate-100 h-44 shimmer"></div>
        <div class="bg-white p-6 rounded-2xl border border-slate-100 h-44 shimmer"></div>
      </div>
      <div id="grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 hidden"></div>

      <!-- 快取空提示 -->
      <div id="empty-state" class="hidden flex flex-col items-center justify-center py-24 text-center">
        <div
          class="w-16 h-16 bg-blue-50 text-blue-400 rounded-full flex items-center justify-center mb-4 shadow-lg shadow-blue-50">
          <i class="fa-solid fa-cloud-arrow-down text-2xl"></i>
        </div>
        <h3 class="text-lg font-bold text-slate-800 mb-2">快取尚未就緒</h3>
        <p class="text-sm text-slate-500 max-w-xs mb-6">請在 Apps Script 中點擊「執行 cacheFeeds」，或等待設定好的觸發器自動執行。</p>
      </div>
    </section>
  </main>

  <!-- 管理彈窗 -->
  <div id="manager-modal"
    class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50 transition-opacity">
    <div onclick="toggleManager(false)" class="absolute w-full h-full bg-slate-900 opacity-60"></div>
    <div
      class="bg-white w-11/12 md:max-w-4xl mx-auto rounded-3xl shadow-2xl z-50 overflow-hidden flex flex-col max-h-[90vh]">
      <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
        <h3 class="text-xl font-bold text-slate-800">訂閱管理中心</h3>
        <button onclick="toggleManager(false)" class="text-slate-400 hover:text-slate-600 p-2 transition-colors"><i
            class="fa-solid fa-xmark text-lg"></i></button>
      </div>
      <div class="p-8 overflow-y-auto flex-1">
        <!-- 新增表單 -->
        <div class="bg-blue-50 p-6 rounded-2xl mb-8">
          <h4 class="text-sm font-bold text-blue-800 mb-4 flex items-center"><i
              class="fa-solid fa-plus-circle mr-2"></i> 快速訂閱</h4>
          <div class="flex flex-col space-y-4">
            <div class="flex flex-col lg:flex-row gap-3">
              <input id="detect-url" type="text" placeholder="輸入網站網址 (例如: example.com)"
                class="flex-1 px-4 py-2.5 rounded-xl border-none ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 text-sm outline-none w-full">

              <div class="flex flex-wrap gap-2 shrink-0">
                <button id="detect-btn" onclick="handleDetectRss()"
                  class="flex-1 md:flex-none px-4 py-2.5 bg-blue-100 text-blue-600 text-sm font-bold rounded-xl hover:bg-blue-200 transition-all flex items-center justify-center whitespace-nowrap">
                  <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>偵測
                </button>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <input id="sub-name" type="text" placeholder="網站名稱"
                class="px-4 py-2 rounded-xl border-none ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 text-sm outline-none">
              <div class="md:col-span-1">
                <select id="sub-category" onchange="checkNewCategory(this, 'sub-category-custom-wrap')"
                  class="w-full px-4 py-2 rounded-xl border-none ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 text-sm outline-none bg-white">
                </select>
                <div id="sub-category-custom-wrap" class="hidden mt-2">
                  <input id="sub-category-custom" type="text" placeholder="請輸入新分類名稱"
                    class="w-full px-4 py-2 rounded-xl border-none ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 text-sm outline-none bg-slate-50">
                </div>
              </div>
              <input id="sub-url" type="text" placeholder="RSS URL (http...)"
                onchange="handleSubUrlAutoDetect(this.value)"
                class="md:col-span-2 px-4 py-2 rounded-xl border-none ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 text-sm outline-none">
              <div class="md:col-span-3 flex items-center justify-between mt-auto pb-1">
                <span class="text-[10px] font-bold text-slate-400 text-slate-400/80">進階管理與備份</span>
                <button onclick="toggleImportExport()"
                  class="text-[11px] font-bold text-blue-600 hover:text-blue-700 flex items-center mr-2">
                  <span id="import-export-toggle-text">開啟進階管理</span>
                  <i id="import-export-toggle-icon" class="fa-solid fa-chevron-down ml-1 transition-transform"></i>
                </button>
              </div>
              <button id="add-btn" onclick="handleAddSub()"
                class="md:col-start-4 px-6 py-2 bg-blue-600 text-white text-sm font-bold rounded-xl hover:bg-blue-700 transition-all shadow-lg shadow-blue-100 flex items-center justify-center space-x-2">
                <span>確認新增</span>
              </button>
            </div>

            <!-- [更新] 匯入匯出與進階管理區塊 (預設隱藏) -->
            <div id="import-export-area"
              class="hidden mt-4 bg-slate-50/50 p-4 rounded-2xl border border-slate-100 animate-fade-in">
              <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div class="flex flex-wrap gap-2">
                  <button onclick="handleExportClick()"
                    class="px-4 py-2 bg-blue-50 text-blue-600 text-xs font-bold rounded-xl hover:bg-blue-100 transition-all flex items-center space-x-2 border border-blue-100">
                    <i class="fa-solid fa-file-export"></i>
                    <span>匯出 OPML (勾選或全部)</span>
                  </button>
                  <label
                    class="cursor-pointer px-4 py-2 bg-white ring-1 ring-slate-200 text-slate-600 text-xs font-bold rounded-xl hover:bg-slate-50 transition-all flex items-center space-x-2">
                    <i class="fa-solid fa-file-import"></i>
                    <span>匯入 OPML 檔案</span>
                    <input type="file" id="import-input" class="hidden" accept=".opml,.xml"
                      onchange="handleImportFile(this)">
                  </label>
                </div>

                <div class="flex items-center space-x-2 bg-white px-3 py-2 rounded-xl border border-slate-200">
                  <span class="text-[10px] font-bold text-slate-400 whitespace-nowrap">匯入至：</span>
                  <select id="import-target-category"
                    class="bg-transparent border-none text-[11px] font-bold text-slate-600 outline-none focus:ring-0 cursor-pointer">
                    <option value="">(依 OPML 分類)</option>
                    <option value="Podcast">Podcast</option>
                    <option value="科技">科技</option>
                    <option value="新聞">新聞</option>
                    <option value="未分類">未分類</option>
                    <option value="NEW">-- 新增分類 --</option>
                  </select>
                </div>

                <div class="flex items-center space-x-2">
                  <button onclick="handleSetupAutoSync()"
                    class="px-3 py-2 bg-green-50 text-green-600 text-[10px] font-bold rounded-xl hover:bg-green-100 transition-all flex items-center"
                    title="設定系統每小時自動更新">
                    <i class="fa-solid fa-clock mr-1.5"></i>設定自動同步
                  </button>
                  <button onclick="handleResetCache()"
                    class="px-3 py-2 bg-red-50 text-red-600 text-[10px] font-bold rounded-xl hover:bg-red-100 transition-all flex items-center"
                    title="清空文章快取並重新抓取">
                    <i class="fa-solid fa-trash-can mr-1.5"></i>重置快取
                  </button>
                </div>
              </div>

              <p class="text-[9px] text-slate-400 mt-3 flex items-center">
                <i class="fa-solid fa-circle-info mr-1"></i>
                提示：導出時若有勾選項目則僅導出選取項；匯入可指定目標資料夾。
              </p>
            </div>
          </div>
        </div>
        <!-- 批次操作 -->
        <div id="batch-actions" class="hidden flex items-center justify-between bg-blue-50 p-3 rounded-xl mb-4 text-xs">
          <div class="flex items-center space-x-3 text-blue-600 font-bold">
            <span id="selected-count">已選擇 0 項</span>
            <button onclick="handleBatchDelete()" class="hover:underline text-red-500"><i
                class="fa-solid fa-trash-can mr-1"></i>批次刪除</button>
            <button onclick="handleBatchMove()" class="hover:underline text-blue-600"><i
                class="fa-solid fa-folder-tree mr-1"></i>批次改分類</button>
          </div>
          <button onclick="clearSelection()" class="text-slate-400 hover:text-slate-600">取消選擇</button>
        </div>
        <!-- 清單 -->
        <div class="flex justify-between items-center mb-4">
          <div class="flex items-center space-x-2">
            <input type="checkbox" id="select-all" onclick="toggleSelectAll(this)" class="rounded text-blue-600">
            <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest">目前訂閱清單 (<span
                id="sub-count-total">0</span>)</h4>
          </div>
        </div>
        <div id="manager-list" class="space-y-4">
          <!-- 項目 -->
        </div>
      </div>
    </div>
  </div>

  <!-- 全文預覽彈窗 (確保在所有 Modal 之外) -->
  <div id="content-modal"
    class="fixed inset-0 z-[200] flex items-center justify-center p-4 md:p-10 opacity-0 pointer-events-none transition-all duration-300">
    <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="closeContentModal()"></div>
    <div
      class="bg-white w-full max-w-4xl rounded-3xl shadow-2xl relative flex flex-col overflow-hidden transform scale-95 transition-all duration-300 max-h-[96vh] md:max-h-[92vh]"
      id="content-modal-body">
      <div
        class="flex flex-col px-4 md:px-6 py-3 md:py-4 border-b border-slate-100 flex-shrink-0 bg-white z-10 gap-2 md:gap-3">
        <!-- 上排：來源訊息與操作按鈕 -->
        <div class="flex justify-between items-center w-full">
          <div class="flex items-center space-x-2 md:space-x-3 overflow-hidden">
            <span id="modal-source"
              class="text-[9px] md:text-[10px] font-bold text-blue-500 uppercase tracking-widest bg-blue-50 px-2 py-1 rounded w-fit shrink-0">來源名稱</span>
            <div id="modal-header-toggle" class="flex-shrink-0"></div>
          </div>
          <div class="flex items-center space-x-1 sm:space-x-3">
            <div id="modal-header-actions" class="flex items-center space-x-1 sm:space-x-3"></div>
            <div class="w-px h-4 bg-slate-100 mx-1"></div>
            <button onclick="closeContentModal()"
              class="h-8 w-8 md:h-10 md:w-10 flex flex-shrink-0 items-center justify-center rounded-full hover:bg-slate-100 text-slate-400 transition-colors">
              <i class="fa-solid fa-xmark text-lg"></i>
            </button>
          </div>
        </div>
        <!-- 下排：標題 (完整寬度) -->
        <h2 id="modal-title"
          class="text-base md:text-xl font-bold text-slate-800 leading-tight break-words whitespace-normal px-0.5">文章標題
        </h2>
      </div>
      <div
        class="modal-content-container p-5 md:p-8 article-content-body flex-1 bg-white text-slate-600 leading-relaxed text-base overflow-y-auto"
        id="modal-body-text">
        <!-- 全文 HTML內容 -->
      </div>
      <div
        class="px-4 md:px-6 py-3 md:py-4 border-t border-slate-100 flex flex-col md:flex-row justify-between items-center gap-3 md:gap-4 flex-shrink-0 bg-white z-10">
        <span id="modal-date" class="text-[11px] md:text-xs text-slate-400 order-2 md:order-1">發布時間</span>
        <a id="modal-link" href="#" target="_blank"
          class="w-full md:w-auto px-6 py-2.5 bg-blue-600 text-white rounded-xl font-bold text-sm shadow-xl shadow-blue-100 hover:bg-blue-700 transition-all flex items-center justify-center whitespace-nowrap order-1 md:order-2">
          查看原文 <i class="fa-solid fa-arrow-up-right-from-square ml-2"></i>
        </a>
      </div>
    </div>
  </div>

  <!-- 編輯訂閱來源彈窗 -->
  <div id="edit-source-modal"
    class="modal fixed inset-0 z-[110] flex items-center justify-center p-4 md:p-10 opacity-0 pointer-events-none transition-all duration-300">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-md" onclick="closeEditSourceModal()"></div>
    <div
      class="bg-white w-full max-w-lg rounded-2xl shadow-2xl relative flex flex-col overflow-hidden transform scale-95 transition-all duration-300">
      <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
        <h3 class="text-lg font-bold text-slate-800">編輯訂閱來源</h3>
        <button onclick="closeEditSourceModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
          <i class="fa-solid fa-xmark text-lg"></i>
        </button>
      </div>
      <div class="p-6 space-y-4">
        <input type="hidden" id="edit-source-index">
        <input type="hidden" id="edit-source-old-cat">
        <div>
          <label class="block text-xs font-bold text-slate-500 mb-1">網站名稱</label>
          <input id="edit-source-name" type="text"
            class="w-full px-4 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 text-sm outline-none">
        </div>
        <div>
          <label class="block text-xs font-bold text-slate-500 mb-1">RSS 連結</label>
          <input id="edit-source-url" type="text"
            class="w-full px-4 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 text-sm outline-none">
        </div>
        <div>
          <label class="block text-xs font-bold text-slate-500 mb-1">分類</label>
          <select id="edit-source-cat" onchange="checkNewCategory(this, 'edit-source-cat-custom-wrap')"
            class="w-full px-4 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 text-sm outline-none bg-white">
          </select>
          <div id="edit-source-cat-custom-wrap" class="hidden mt-2">
            <input id="edit-source-cat-custom" type="text" placeholder="請輸入新分類名稱"
              class="w-full px-4 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 text-sm outline-none bg-slate-50">
          </div>
        </div>
      </div>
      <div class="p-5 border-t border-slate-100 flex justify-end space-x-2 bg-slate-50">
        <button onclick="closeEditSourceModal()"
          class="px-4 py-2 rounded-lg text-slate-500 hover:bg-slate-200 text-sm font-bold transition-colors">取消</button>
        <button onclick="handleSaveSource()"
          class="px-5 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold shadow-lg shadow-blue-100 hover:bg-blue-700 transition-all">儲存變更</button>
      </div>
    </div>
  </div>

  <!-- 批次移動分類彈窗 -->
  <div id="batch-move-modal"
    class="modal fixed inset-0 z-[120] flex items-center justify-center p-4 md:p-10 opacity-0 pointer-events-none transition-all duration-300">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-md" onclick="closeBatchMoveModal()"></div>
    <div
      class="bg-white w-full max-w-sm rounded-2xl shadow-2xl relative flex flex-col overflow-hidden transform scale-95 transition-all duration-300">
      <div class="p-5 border-b border-slate-100 bg-slate-50">
        <h3 class="text-lg font-bold text-slate-800">批次修改分類</h3>
      </div>
      <div class="p-6">
        <label class="block text-xs font-bold text-slate-500 mb-2">選擇或輸入新分類</label>
        <select id="batch-move-cat" onchange="checkNewCategory(this, 'batch-move-cat-custom-wrap')"
          class="w-full px-4 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 text-sm outline-none bg-white">
        </select>
        <div id="batch-move-cat-custom-wrap" class="hidden mt-2">
          <input id="batch-move-cat-custom" type="text" placeholder="請輸入新分類名稱"
            class="w-full px-4 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 text-sm outline-none bg-slate-50">
        </div>
      </div>
      <div class="p-5 border-t border-slate-100 flex justify-end space-x-2 bg-slate-50">
        <button onclick="closeBatchMoveModal()"
          class="px-4 py-2 rounded-lg text-slate-500 hover:bg-slate-200 text-sm font-bold transition-colors">取消</button>
        <button onclick="submitBatchMove()"
          class="px-5 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold shadow-lg shadow-blue-100 hover:bg-blue-700 transition-all">確認移動</button>
      </div>
    </div>
  </div>

  <!-- 設定預設 URL (請使用者部署後填入此處可免每次設定) -->
  <script>
    /**
     * [硬編碼預設值] 使用者可直接在此填入部署後的 GAS Web App URL
     * 例如: const DEFAULT_GAS_URL = "https://script.google.com/macros/s/XXXXX/exec";
     */
    const DEFAULT_GAS_URL = "";

    // 核心資料物件
    let allData = { articles: [], readIds: new Set(), starredIds: new Set(), subscriptions: [], queue: [], podcastProgress: {}, settings: {}, spreadsheetUrl: "" };

    /**
     * 獲取目前有效的 GAS URL (優先權: 網址參數 > LocalStorage > 硬編碼)
     */
    function getGasUrl() {
      // 1. 檢查網址參數 ?config=BASE64_URL
      const urlParams = new URLSearchParams(window.location.search);
      const configParam = urlParams.get('config');
      if (configParam) {
        try {
          const decodedUrl = atob(configParam);
          if (decodedUrl.startsWith('http')) {
            localStorage.setItem('gas_web_app_url', decodedUrl);
            // 移除參數避免重複讀取
            window.history.replaceState({}, document.title, window.location.pathname);
            return decodedUrl;
          }
        } catch (e) { console.error("Base64 decode failed", e); }
      }

      // 2. 本地儲存
      const storedUrl = localStorage.getItem('gas_web_app_url');
      if (storedUrl) return storedUrl;

      // 3. 硬編碼預設值
      return DEFAULT_GAS_URL;
    }

    /**
     * 封裝 API 呼叫 (fetch 跨網域 POST/GET)
     */
    async function callApi(action, data = {}, isPost = true, silent = false, retryCount = 0) {
      const url = getGasUrl();
      if (!url) {
        if (!silent) showCustomModal("連線設定請求", "尚未設定 GAS Web App URL。請點擊側邊欄的 ⚙️ 按鈕進行設定，或是使用分享連結。");
        throw new Error("Missing GAS URL");
      }

      try {
        let response;
        if (isPost) {
          response = await fetch(url, {
            method: 'POST',
            mode: 'cors', // 處理跨網域
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify({ action, ...data })
          });
        } else {
          const queryParams = new URLSearchParams({ action, ...data });
          response = await fetch(`${url}?${queryParams.toString()}`, {
            method: 'GET',
            mode: 'cors'
          });
        }

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();

        if (result.success === false && !silent) {
          showCustomModal("系統提示", result.message, "error");
        }
        return result.data || result;
      } catch (e) {
        // [優化] 針對型別錯誤 (通常是網路斷線或 Fetch 失敗) 進行一次自動重試
        const isNetworkError = (e instanceof TypeError) || e.toString().toLowerCase().includes('fetch');
        if (isNetworkError && retryCount < 1) {
          console.warn(`[API] 網路異常，嘗試第二次連線 (${action})...`, e);
          await new Promise(r => setTimeout(r, 1500));
          return callApi(action, data, isPost, silent, retryCount + 1);
        }

        console.error("API Call Error:", e);
        if (silent === 'toast') {
          showToast("連線更新失敗，請檢查網路狀態", "error");
        } else if (!silent) {
          showCustomModal("連線失敗", "無法連接至 Google 伺服器，請檢查網路狀態或 API 網址是否正確。\n\n錯誤訊息：" + e.toString(), "error");
        }
        throw e;
      }
    }

    /**
     * 自定義 Modal 系統 (替代 alert/confirm)
     */
    function showCustomModal(title, message, type = 'info') {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 z-[300] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-fade-in';

      const content = document.createElement('div');
      content.className = 'bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden transform scale-95 transition-all animate-pop-in';

      let iconColor = 'text-blue-500';
      let icon = 'fa-circle-info';
      if (type === 'error') { iconColor = 'text-red-500'; icon = 'fa-circle-exclamation'; }
      if (type === 'success') { iconColor = 'text-green-500'; icon = 'fa-circle-check'; }

      content.innerHTML = `
        <div class="p-6 text-center">
          <div class="w-12 h-12 ${iconColor} bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fa-solid ${icon} text-2xl"></i>
          </div>
          <h3 class="text-lg font-bold text-slate-800 mb-2">${title}</h3>
          <p class="text-sm text-slate-500 whitespace-pre-wrap">${message}</p>
        </div>
        <div class="p-4 bg-slate-50 border-t border-slate-100 flex justify-center">
          <button class="px-8 py-2 bg-blue-600 text-white rounded-xl font-bold text-sm shadow-md hover:bg-blue-700 transition-all">確定</button>
        </div>
      `;

      modal.appendChild(content);
      document.body.appendChild(modal);

      const btn = content.querySelector('button');
      btn.onclick = () => {
        modal.classList.add('opacity-0');
        setTimeout(() => modal.remove(), 200);
      };
    }

    let showUnreadOnly = true;
    let currentSourceFilter = null;
    let currentCategoryFilter = null;
    let isReadLaterFilter = false;
    let displayLimit = 20;
    let isLoadingMore = false;
    let collapsedCategories = new Set();
    let collapsedManagerCats = new Set();
    let selectedSubIndices = new Set();
    let displayMode = localStorage.getItem('rss_display_mode') || 'grid';
    let searchQuery = "";

    // Podcast States
    let currentPlaybackSpeed = parseFloat(localStorage.getItem('podcast_speed')) || 1.0;
    let playerDisplayMode = localStorage.getItem('podcast_display_mode') || 'bar'; // 'bar', 'ball'
    let currentPlayingId = null;

    // [新增] 追蹤中斷的同步任務 (強制轉為 Number 避免型別不匹配)
    let pendingSyncSources = new Set();
    try {
      const saved = JSON.parse(localStorage.getItem('rss_pending_sync') || '[]');
      if (Array.isArray(saved)) saved.forEach(id => pendingSyncSources.add(Number(id)));
    } catch (e) {
      console.error("Pending sync restore failed:", e);
    }

    function savePendingSync() {
      localStorage.setItem('rss_pending_sync', JSON.stringify(Array.from(pendingSyncSources)));
    }

    function clearPendingSync() {
      pendingSyncSources.clear();
      savePendingSync();
      refreshAll();
      showToast("已清除所有中斷圖示狀態");
    }

    window.onload = () => {
      updateDisplayModeUI();

      // 1. 初始化主題
      initTheme();

      // 2. 嘗試讀取本地快取
      loadStateFromLocal();

      // [新增] 套用速度與顯示模式介面
      syncSpeedUI();
      applyPlayerDisplay();

      // 3. 初始載入
      refreshAll();

      // 監聽內容區域的捲動事件以實現無限載入
      const contentArea = document.getElementById('content-area');
      contentArea.addEventListener('scroll', () => {
        if (contentArea.scrollTop + contentArea.clientHeight >= contentArea.scrollHeight - 500) {
          loadMoreArticles();
        }
      });

      // 備援：如果 8 秒後載入動畫還沒消失，強制關閉它 (防止某些 JS 錯誤導致畫面卡死)
      setTimeout(() => {
        const loader = document.getElementById('loader');
        if (loader && !loader.classList.contains('hidden')) {
          console.warn("Safety timeout: hiding loader.");
          loader.classList.add('hidden');
          document.getElementById('grid').classList.remove('hidden');
        }
      }, 8000);
    };



    /* --- Theme Manager --- */
    const themes = ['', 'theme-warm', 'theme-dark', 'theme-midnight'];
    let currentThemeIndex = 0;

    function initTheme() {
      const saved = localStorage.getItem('rss_theme');
      if (saved) {
        currentThemeIndex = themes.indexOf(saved);
        if (currentThemeIndex === -1) currentThemeIndex = 0;
      }
      applyTheme();
    }

    function cycleTheme() {
      currentThemeIndex = (currentThemeIndex + 1) % themes.length;
      applyTheme();
      const themeName = ['預設淺色', '舒適暖色', '深色模式', '午夜全黑'][currentThemeIndex];
      showToast(`已切換主題：${themeName}`);
    }

    function applyTheme() {
      document.body.className = document.body.className.replace(/theme-\w+/g, '').trim();
      const themeClass = themes[currentThemeIndex];
      if (themeClass) document.body.classList.add(themeClass);
      localStorage.setItem('rss_theme', themeClass);
    }

    /* --- Local Storage Cache --- */
    function saveStateToLocal() {
      try {
        const data = {
          timestamp: Date.now(),
          subscriptions: allData.subscriptions,
          articles: allData.articles,
          readIds: Array.from(allData.readIds || []),
          collapsedCategories: Array.from(collapsedCategories || []),
          queue: allData.queue,
          podcastProgress: allData.podcastProgress
        };
        localStorage.setItem('rss_data_cache', JSON.stringify(data));
        console.log("Local cache saved.");
      } catch (e) {
        console.error("Save cache failed:", e);
      }
    }

    function loadStateFromLocal() {
      try {
        const json = localStorage.getItem('rss_data_cache');
        if (!json) return;
        const data = JSON.parse(json);

        if (data.subscriptions) allData.subscriptions = data.subscriptions;
        if (data.articles) allData.articles = data.articles;
        if (data.readIds) allData.readIds = new Set(data.readIds);
        if (data.collapsedCategories) collapsedCategories = new Set(data.collapsedCategories);
        if (data.queue) allData.queue = data.queue;
        if (data.podcastProgress) allData.podcastProgress = data.podcastProgress;

        // 立即渲染
        sortAndCacheArticles();
        renderSidebar();
        renderArticles();
        renderQueue();

        // 初始化播放器顯示模式
        applyPlayerDisplay();

        console.log("Loaded from local cache.");
      } catch (e) {
        console.error("Load cache failed:", e);
        localStorage.removeItem('rss_data_cache');
      }
    }

    function toggleDisplayMode() {
      const newMode = (displayMode === 'grid') ? 'list' : 'grid';
      displayMode = newMode;
      localStorage.setItem('rss_display_mode', newMode);
      updateDisplayModeUI();
      renderArticles();
    }

    function updateDisplayModeUI() {
      const icon = document.getElementById('display-mode-icon');
      const mobileIcon = document.querySelector('.mobile-display-icon');
      const className = (displayMode === 'grid') ? 'fa-solid fa-grip text-sm' : 'fa-solid fa-list text-sm';
      if (icon) icon.className = className;
      if (mobileIcon) mobileIcon.className = 'mobile-display-icon ' + className;
    }

    function sortAndCacheArticles() {
      if (!allData.articles) return;
      allData.articles.sort((a, b) => {
        const timeA = a._time || (a._time = new Date(a.date).getTime() || 0);
        const timeB = b._time || (b._time = new Date(b.date).getTime() || 0);
        return timeB - timeA;
      });
      _cachedFilteredArticles = null; // 清除快取以強制重算
    }

    async function refreshAll() {
      const icon = document.getElementById('refresh-icon');
      const mobileIcon = document.getElementById('mobile-refresh-icon');
      const loader = document.getElementById('loader');
      const grid = document.getElementById('grid');
      const updateEl = document.getElementById('last-update');
      const emptyEl = document.getElementById('empty-state');

      [icon, mobileIcon].forEach(el => el?.classList.add('fa-spin'));
      const hasCache = allData.articles && allData.articles.length > 0;
      if (!hasCache) {
        grid.classList.add('hidden');
        emptyEl.classList.add('hidden');
        loader.classList.remove('hidden');
      }

      try {
        const hasCache = allData.articles && allData.articles.length > 0;
        const res = await callApi('getAllData', {}, false, hasCache ? 'toast' : false);
        if (res) {
          allData = res;
          allData.articles = res.articles || [];
          allData.readIds = new Set(res.readIds || []);
          allData.starredIds = new Set(res.starredIds || []);
          allData.subscriptions = res.subscriptions || [];
          allData.settings = res.settings || {};
          allData.queue = res.podcastQueue || []; // 確保始終為陣列
          allData.podcastProgress = res.podcastProgress || {};

          // [新增] 還原播放器狀態 (正在播放ID, 速度, 顯示模式)
          if (res.playerState) {
            const ps = res.playerState;
            currentPlaybackSpeed = ps.speed || 1;
            playerDisplayMode = ps.mode || 'bar';

            // 如果雲端有紀錄正在播放，且本地目前沒在放，則嘗試載入
            if (ps.currentId && !currentPlayingId) {
              const activeArt = allData.articles.find(it => it.id === ps.currentId);
              if (activeArt) {
                initPlayer(activeArt, false); // 不自動播放，僅載入狀態
              }
            }
            syncSpeedUI(); // 同步雲端速度
          }

          if (res.spreadsheetUrl) {
            allData.spreadsheetUrl = res.spreadsheetUrl;
            const logoLink = document.getElementById('logo-link');
            if (logoLink) logoLink.href = res.spreadsheetUrl;
          }
          sortAndCacheArticles();
          applyPlayerDisplay();

          if (res.isInterrupted) {
            updateEl.innerHTML = `<span class="text-amber-500 font-bold">同步中斷，自動續傳中...</span>`;
            setTimeout(() => handleManualCache(), 1000);
          } else {
            updateEl.innerText = res.lastUpdate || "剛剛";
            saveStateToLocal();
          }

          requestAnimationFrame(() => {
            renderSidebar();
            renderArticles();
            renderManagerList();
            updateCategoryDropdown();
          });
        }
      } catch (err) {
        console.error("Refresh failed", err);
      } finally {
        [icon, mobileIcon].forEach(el => el?.classList.remove('fa-spin'));
        loader.classList.add('hidden');
        grid.classList.remove('hidden');
      }
    }

    async function handleManualCache() {
      const icon = document.getElementById('cache-icon');
      const statusArea = document.getElementById('sync-status-area');
      const subs = allData.subscriptions;

      if (!subs || subs.length === 0) {
        showCustomModal("系統提示", "沒有可同步的訂閱來源", "error");
        return;
      }

      icon.classList.add('fa-spin', 'text-blue-600');
      statusArea.innerHTML = `<span class="text-blue-600 font-medium">同步中...</span>`;

      try {
        await callApi('manualSync', {});
        refreshAll();
        showToast("手動同步已完成");
      } catch (err) {
        console.error("Manual sync failed", err);
      } finally {
        icon.classList.remove('fa-spin', 'text-blue-600');
      }
    }

    async function handleResetCache() {
      if (!confirm("確定要重置快取嗎？這將清空所有的文章紀錄並重新抓取（可能需要較長時間）。")) return;

      const icon = document.getElementById('cache-icon');
      const statusArea = document.getElementById('sync-status-area');
      icon.classList.add('fa-spin', 'text-blue-600');
      statusArea.innerHTML = `<span class="text-blue-600 font-medium">重置重建中...</span>`;

      try {
        const res = await callApi('manualSync', { fullReset: true });
        if (res.success) {
          showToast("快取已重建完成");
          refreshAll();
        }
      } catch (err) {
        console.error("Reset cache failed", err);
      } finally {
        icon.classList.remove('fa-spin', 'text-blue-600');
      }
    }

    async function handleSetupAutoSync() {
      showToast("正在設定每小時同步...", "info");
      try {
        const res = await callApi('setupTriggers', {});
        if (res.success) showToast("已開啟自動同步", "success");
      } catch (err) {
        console.error("Setup triggers failed", err);
      }
    }

    function loadMoreArticles() {
      if (isLoadingMore) return;
      const filteredCount = getFilteredArticles().length;
      if (displayLimit < filteredCount) {
        isLoadingMore = true;
        displayLimit += 20;
        renderArticles(true); // 傳入 true 表示是追加載入，不重捲
        isLoadingMore = false;
      }
    }

    function toggleManager(show) {
      const m = document.getElementById('manager-modal');
      const b = document.querySelector('body');
      if (show) {
        m.classList.remove('opacity-0', 'pointer-events-none');
        b.classList.add('modal-active');
      } else {
        m.classList.add('opacity-0', 'pointer-events-none');
        b.classList.remove('modal-active');
      }
    }

    function toggleSidebar(show) {
      const sb = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      if (show) {
        sb.classList.remove('-translate-x-full');
        overlay.classList.remove('opacity-0', 'pointer-events-none');
      } else {
        sb.classList.add('-translate-x-full');
        overlay.classList.add('opacity-0', 'pointer-events-none');
      }
    }

    function toggleMobileSearch() {
      const bar = document.getElementById('mobile-search-bar');
      const input = document.getElementById('mobile-search-input');

      if (bar.classList.contains('hidden')) {
        bar.classList.remove('hidden');
        input.focus();
      } else {
        bar.classList.add('hidden');
        input.value = '';
        handleSearch(''); // Clear search results
      }
    }

    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-emerald-500' : 'bg-red-500';
      toast.className = `toast ${bgColor} text-white px-6 py-3 rounded-xl shadow-lg mb-3 flex items-center space-x-2 text-sm font-medium`;
      toast.innerHTML = `
        <i class="fa-solid ${type === 'success' ? 'fa-circle-check' : 'fa-circle-exclamation'}"></i>
        <span>${message}</span>
      `;
      container.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(20px)';
        toast.style.transition = 'all 0.5s ease';
        setTimeout(() => toast.remove(), 500);
      }, 3000);
    }

    function toggleLoader(btnId, show) {
      const btn = document.getElementById(btnId);
      if (!btn) return;
      if (show) {
        btn.disabled = true;
        btn.classList.add('opacity-70', 'cursor-not-allowed');
        const span = btn.querySelector('span');
        const icon = btn.querySelector('i');
        if (span) span.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>處理中...';
        if (icon && btnId === 'detect-btn') icon.className = 'fa-solid fa-spinner fa-spin mr-2';
      } else {
        btn.disabled = false;
        btn.classList.remove('opacity-70', 'cursor-not-allowed');
        const span = btn.querySelector('span');
        const icon = btn.querySelector('i');
        if (span) span.innerHTML = (btnId === 'add-btn') ? '確認新增' : '儲存更改';
        if (icon && btnId === 'detect-btn') icon.className = 'fa-solid fa-wand-magic-sparkles mr-2';
      }
    }

    async function handleDetectRss() {
      const url = document.getElementById('detect-url').value.trim();
      if (!url) return showToast("請輸入網站網址", "error");

      toggleLoader('detect-btn', true);
      try {
        const res = await callApi('detectRss', { url }, false);
        if (res.success) {
          document.getElementById('sub-name').value = res.name;
          document.getElementById('sub-url').value = res.url;
          showToast("成功偵測 RSS 資訊！");
        }
      } catch (err) {
        console.error("Detect RSS failed", err);
      } finally {
        toggleLoader('detect-btn', false);
      }
    }

    async function handleSubUrlAutoDetect(url) {
      if (!url || !url.startsWith('http')) return;
      const nameInput = document.getElementById('sub-name');
      if (nameInput.value.trim()) return;

      try {
        const res = await callApi('detectRss', { url }, false, true);
        if (res.success && res.name) {
          nameInput.value = res.name;
          showToast(`已自動偵測網站標題：${res.name}`);
        }
      } catch (e) { }
    }

    async function handleAddSub() {
      const n = document.getElementById('sub-name').value.trim();
      const u = document.getElementById('sub-url').value.trim();
      const c = getCategoryValue('sub-category');

      if (!n || !u) return showToast("請輸入完整的名稱與網址", "error");

      toggleLoader('add-btn', true);
      try {
        const res = await callApi('addSubscription', { name: n, url: u, category: c });
        if (res.success) {
          document.getElementById('sub-name').value = '';
          document.getElementById('sub-url').value = '';
          const select = document.getElementById('sub-category');
          select.value = '未分類';
          checkNewCategory(select, 'sub-category-custom-wrap');
          showToast("已成功新增訂閱");
          refreshAll();
        }
      } catch (err) {
        console.error("Add sub failed", err);
      } finally {
        toggleLoader('add-btn', false);
      }
    }

    async function handleDeleteSub(index) {
      if (!confirm("確定要刪除這個訂閱嗎？")) return;

      try {
        const res = await callApi('deleteSubscription', { rowIndex: index });
        if (res.success) {
          showToast("已刪除訂閱");
          refreshAll();
        }
      } catch (err) {
        console.error("Delete sub failed", err);
      }
    }

    function handleEditSub(index, name, url, category) {
      openEditSourceModal(index, name, url, category);
    }

    function openEditSourceModal(index, name, url, category) {
      const m = document.getElementById('edit-source-modal');
      const b = document.body;

      document.getElementById('edit-source-index').value = index;
      document.getElementById('edit-source-name').value = name;
      document.getElementById('edit-source-url').value = url;
      document.getElementById('edit-source-cat').value = category || '未分類';
      document.getElementById('edit-source-old-cat').value = category || '未分類';

      m.classList.remove('opacity-0', 'pointer-events-none');
      m.querySelector('div.transform').classList.remove('scale-95');
      m.querySelector('div.transform').classList.add('scale-100');
      b.classList.add('modal-active');

      // 更新分類清單
      updateCategoryDropdown();
      const select = document.getElementById('edit-source-cat');
      select.value = category || '未分類';
      checkNewCategory(select, 'edit-source-cat-custom-wrap');
    }

    function closeEditSourceModal() {
      const m = document.getElementById('edit-source-modal');
      const b = document.body;
      m.classList.add('opacity-0', 'pointer-events-none');
      m.querySelector('div.transform').classList.remove('scale-100');
      m.querySelector('div.transform').classList.add('scale-95');
      b.classList.remove('modal-active');
    }

    async function handleSaveSource() {
      const index = document.getElementById('edit-source-index').value;
      const n = document.getElementById('edit-source-name').value.trim();
      const u = document.getElementById('edit-source-url').value.trim();
      const c = getCategoryValue('edit-source-cat');

      if (!n || !u) return showToast("名稱與網址不能為空", "error");

      closeEditSourceModal();
      try {
        const res = await callApi('updateSubscription', { rowIndex: index, name: n, url: u, category: c });
        if (res.success) {
          showToast("已成功更新訂閱");
          refreshAll();
        }
      } catch (e) {
        console.error("Update source failed", e);
      }
    }

    function updateCategoryDropdown() {
      const cats = [...new Set(allData.subscriptions.map(s => s.category || '未分類'))];
      if (!cats.includes('未分類')) cats.push('未分類');
      cats.sort();

      const optionsHtml = cats.map(c => `<option value="${c}">${c}</option>`).join('') +
        `<option value="__NEW__" class="font-bold text-blue-600">+ 新增分類...</option>`;

      const selects = ['sub-category', 'edit-source-cat', 'batch-move-cat'];
      selects.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          const currentVal = el.value;
          el.innerHTML = optionsHtml;
          if (currentVal && cats.includes(currentVal)) el.value = currentVal;
        }
      });
    }

    function checkNewCategory(select, wrapId) {
      const wrap = document.getElementById(wrapId);
      if (select.value === '__NEW__') {
        wrap.classList.remove('hidden');
        wrap.querySelector('input').focus();
      } else {
        wrap.classList.add('hidden');
      }
    }

    function getCategoryValue(baseId) {
      const select = document.getElementById(baseId);
      const customInput = document.getElementById(baseId + '-custom');
      if (select && select.value === '__NEW__') {
        return (customInput ? customInput.value.trim() : '') || '未分類';
      }
      return (select ? select.value : '未分類');
    }

    function renderSidebar() {
      const list = document.getElementById('category-list');
      list.innerHTML = '';
      updateCategoryDropdown();

      // 先計算每個來源與各分類的未讀數
      const counts = {};
      const catCounts = {};
      let totalUnread = 0;
      let starredUnread = 0;

      allData.articles.forEach(a => {
        if (!allData.readIds.has(a.id)) {
          totalUnread++;
          if (allData.starredIds && allData.starredIds.has(a.id)) {
            starredUnread++;
          }

          counts[a.source] = (counts[a.source] || 0) + 1;
          const sub = allData.subscriptions.find(s => s.name === a.source);
          if (sub) {
            const cat = sub.category || '未分類';
            catCounts[cat] = (catCounts[cat] || 0) + 1;
          }
        }
      });

      // 更新頂部總計數字
      const allCountEl = document.getElementById('all-articles-count');
      const starCountEl = document.getElementById('star-articles-count');

      if (allCountEl) {
        allCountEl.innerText = totalUnread > 0 ? totalUnread : '';
        allCountEl.style.display = totalUnread > 0 ? 'inline-block' : 'none';
      }
      if (starCountEl) {
        starCountEl.innerText = starredUnread > 0 ? starredUnread : '';
        starCountEl.style.display = starredUnread > 0 ? 'inline-block' : 'none';
      }

      // 按分類分組
      const groups = {};
      allData.subscriptions.forEach(s => {
        const cat = s.category || '未分類';
        if (!groups[cat]) groups[cat] = [];
        groups[cat].push(s);
      });

      Object.keys(groups).sort().forEach(cat => {
        const isCollapsed = collapsedCategories.has(cat);
        const isCatActive = currentCategoryFilter === cat;

        // 渲染分類標題
        const header = document.createElement('div');
        const unreadCount = catCounts[cat] || 0;
        header.className = `category-header group flex items-center justify-between ${isCollapsed ? 'collapsed' : ''} ${isCatActive ? 'active' : ''}`;

        // 分類狀態顯示邏輯：跟來源一樣，有未讀顯數字，沒未讀顯圖示，點擊皆可同步
        let catStatusHtml = "";
        const catIdForSync = `sidebar-cat-sync-${cat.replace(/\s+/g, '-')}`;

        if (unreadCount > 0) {
          catStatusHtml = `<span id="${catIdForSync}" class="px-1.5 py-0.5 bg-blue-100 text-blue-600 text-[10px] font-bold rounded-md cursor-pointer hover:bg-blue-200 transition-all font-mono"
                                onclick="event.stopPropagation(); handleSyncCategory('${cat.replace(/'/g, "\\'")}', this)"
                                title="此分類共 ${unreadCount} 則未讀 - 點擊同步整個分類">${unreadCount}</span>`;
        } else {
          catStatusHtml = `<i id="${catIdForSync}" class="sidebar-sync-btn fa-solid fa-rotate text-[10px] text-slate-300 hover:text-blue-500 cursor-pointer transition-all"
                              onclick="event.stopPropagation(); handleSyncCategory('${cat.replace(/'/g, "\\'")}', this)"
                              title="同步整個分類"></i>`;
        }

        header.innerHTML = `
          <div class="flex items-center flex-1 min-w-0" onclick="setCategoryFilter('${cat}')">
            <i class="fa-solid ${isCollapsed ? 'fa-folder' : 'fa-folder-open'} text-sm flex-shrink-0 mr-2" 
               onclick="event.stopPropagation(); toggleCategoryCollapse('${cat}')"></i>
            <span class="truncate leading-none font-bold">${cat}</span>
          </div>
          <div class="flex-shrink-0 w-8 h-6 flex items-center justify-end">
            ${catStatusHtml}
          </div>
        `;
        list.appendChild(header);

        if (!isCollapsed) {
          groups[cat].forEach(s => {
            const unreadCount = counts[s.name] || 0;
            const isError = s.status && s.status !== 'OK' && s.status !== 'New' && s.status !== 'Updated';
            const isActive = currentSourceFilter === s.name;

            let secondaryIcon = "";
            // [新增] 偵測是否為中斷項目 (轉為 Number 確保匹配)
            const isInterrupted = !s.isFrozen && pendingSyncSources.has(Number(s.index));

            if (isInterrupted) {
              secondaryIcon = `<i id="sidebar-sync-icon-${s.index}" class="fa-solid fa-clock-rotate-left text-[10px] text-amber-500 cursor-pointer animate-pulse" 
                                   onclick="event.stopPropagation(); handleSyncSingleSource('${s.name.replace(/'/g, "\\'")}', this)"
                                   title="上次同步中斷，點擊點擊續傳"></i>`;
            } else if (isError) {
              secondaryIcon = `<i id="sidebar-sync-icon-${s.index}" class="fa-solid fa-circle-exclamation text-[10px] text-red-500 hover:text-red-700 cursor-pointer animate-pulse" 
                                   onclick="event.stopPropagation(); handleSyncSingleSource('${s.name.replace(/'/g, "\\'")}', this)"
                                   title="同步失敗 (${s.lastChecked}) - 點擊重新同步"></i>`;
            } else if (unreadCount > 0) {
              secondaryIcon = `<span id="sidebar-sync-icon-${s.index}" class="px-1.5 py-0.5 bg-blue-100 text-blue-600 text-[10px] font-bold rounded-md cursor-pointer hover:bg-blue-200 transition-all font-mono"
                                     onclick="event.stopPropagation(); handleSyncSingleSource('${s.name.replace(/'/g, "\\'")}', this)"
                                     title="未讀文章數 - 點擊立即重新同步">${unreadCount}</span>`;
            } else if (s.isFrozen) {
              secondaryIcon = `<i id="sidebar-sync-icon-${s.index}" class="sidebar-sync-btn fa-solid fa-snowflake text-[10px] text-blue-200 cursor-pointer hover:text-blue-400 transition-all"
                                   onclick="event.stopPropagation(); handleSyncSingleSource('${s.name.replace(/'/g, "\\'")}', this)"
                                   title="已進入冷凍庫 (每週巡邏一次) - 點擊可強制同步"></i>`;
            } else {
              secondaryIcon = `<i id="sidebar-sync-icon-${s.index}" class="sidebar-sync-btn fa-solid fa-rotate-right text-[10px] text-slate-300 hover:text-blue-500 cursor-pointer transition-all"
                                   onclick="event.stopPropagation(); handleSyncSingleSource('${s.name.replace(/'/g, "\\'")}', this)"
                                   title="點擊立即重新同步"></i>`;
            }

            const d = document.createElement('div');
            d.onclick = () => setSourceFilter(s.name);
            d.className = `sidebar-item group relative flex items-center px-3 py-2 text-sm rounded-lg mb-0.5 transition-all cursor-pointer ${isActive ? 'active' : 'text-slate-600 hover:bg-slate-50'} ${s.isFrozen ? 'opacity-50 hover:opacity-100' : ''}`;
            const favicon = getFaviconUrl(s.url);
            d.innerHTML = `
              <div class="flex items-center min-w-0 flex-1 pl-0 pr-2" title="最後同步: ${s.lastChecked || '未知'}">
                <img src="${favicon}" onerror="this.style.display='none'" class="w-4 h-4 mr-2 rounded-sm flex-shrink-0 opacity-80" />
                <span class="truncate leading-none ${isError ? 'text-red-400 font-bold' : ''}">${s.name}</span>
              </div>
              
              <!-- 常駐顯示的未讀/同步狀態 (固定寬度且靠右對齊) -->
              <div class="flex-shrink-0 w-8 h-6 flex items-center justify-end">
                ${secondaryIcon}
              </div>

              <!-- 浮動的管理按鈕 (遮在文字尾部上方) -->
              <div class="absolute right-8 flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                 <button onclick="event.stopPropagation(); openEditSourceModal('${s.index}', '${s.name.replace(/'/g, "\\'")}', '${s.url.replace(/'/g, "\\'")}', '${(s.category || '未分類').replace(/'/g, "\\'")}')" 
                         class="w-7 h-7 flex items-center justify-center rounded-md text-blue-500 bg-white shadow-md border border-blue-50 hover:bg-blue-50 transition-all font-bold" title="編輯來源">
                   <i class="fa-solid fa-pen-to-square text-[10px]"></i>
                 </button>
                 <button onclick="event.stopPropagation(); handleDeleteSub('${s.index}')" 
                         class="w-7 h-7 flex items-center justify-center rounded-md text-red-500 bg-white shadow-md border border-red-50 hover:bg-red-50 transition-all font-bold" title="刪除來源">
                   <i class="fa-solid fa-trash-can text-[10px]"></i>
                 </button>
              </div>
            `;
            list.appendChild(d);
          });
        }
      });
    }

    function toggleCategoryCollapse(cat) {
      if (collapsedCategories.has(cat)) collapsedCategories.delete(cat);
      else collapsedCategories.add(cat);
      renderSidebar();
    }

    function getFaviconUrl(url) {
      try {
        const domain = new URL(url).hostname;
        return `https://www.google.com/s2/favicons?domain=${domain}&sz=32`;
      } catch (e) {
        return '';
      }
    }

    function setCategoryFilter(catName) {
      currentCategoryFilter = catName;
      currentSourceFilter = null;
      isReadLaterFilter = false;
      displayLimit = 20;
      updateFilterButtonsUI();

      document.getElementById('view-title').innerText = `分類：${catName}`;
      document.getElementById('view-actions').innerHTML = `
        <button onclick="handleRenameCategoryDirect('${catName}')" class="hover:text-blue-600 transition-colors flex items-center" title="重新命名分類">
          <i class="fa-solid fa-pen-to-square text-[10px]"></i>
        </button>
        <button onclick="handleDeleteCategoryDirect('${catName}')" class="hover:text-red-500 transition-colors flex items-center" title="刪除此分類下所有訂閱">
          <i class="fa-solid fa-trash-can text-[10px]"></i>
        </button>
      `;

      renderArticles();
      renderSidebar();
      setTimeout(() => toggleSidebar(false), 50);
    }

    function handleRenameCategoryDirect(catName) {
      const newName = prompt('請輸入新的分類名稱', catName);
      if (newName && newName !== catName) {
        handleRenameCat(catName, newName); // 復用現有邏輯
      }
    }

    async function handleDeleteCategoryDirect(catName) {
      if (confirm(`確定要刪除「${catName}」分類下的所有訂閱嗎？此操作無法復原。`)) {
        try {
          const res = await callApi('deleteCategorySubscriptions', { category: catName });
          if (res.success) {
            showToast(`已刪除分類「${catName}」`);
            refreshAll();
          }
        } catch (e) {
          console.error("Delete category failed", e);
        }
      }
    }

    function setSourceFilter(sourceName) {
      toggleSidebar(false); // 點選後立即縮回，提升手機反應速度
      currentSourceFilter = sourceName;
      currentCategoryFilter = null;
      isReadLaterFilter = false;
      displayLimit = 20;
      updateFilterButtonsUI();

      const sub = allData.subscriptions.find(s => s.name === sourceName);
      document.getElementById('view-title').innerText = sub ? `來源：${sourceName}` : sourceName;

      const actionsEl = document.getElementById('view-actions');
      if (sub) {
        actionsEl.innerHTML = `
          <button onclick="handleEditSub(${sub.index}, '${sub.name.replace(/'/g, "\\'")}', '${sub.url.replace(/'/g, "\\'")}', '${(sub.category || '未分類').replace(/'/g, "\\'")}')" 
                  class="hover:text-blue-600 transition-colors flex items-center" title="修改訂閱資訊">
            <i class="fa-solid fa-pen-to-square text-[10px]"></i>
          </button>
          <button onclick="handleDeleteSub(${sub.index})" 
                  class="hover:text-red-500 transition-colors flex items-center" title="刪除此訂閱">
            <i class="fa-solid fa-trash-can text-[10px]"></i>
          </button>
        `;
      } else {
        actionsEl.innerHTML = '';
      }

      renderArticles();
      renderSidebar();
    }

    function setReadLaterFilter() {
      isReadLaterFilter = true;
      currentCategoryFilter = null;
      currentSourceFilter = null;
      displayLimit = 20;
      updateFilterButtonsUI();
      document.getElementById('view-title').innerText = `稍候閱讀 (星號標記)`;
      document.getElementById('view-actions').innerHTML = '';
      renderArticles();
      renderSidebar();
      setTimeout(() => toggleSidebar(false), 50);
    }

    function resetFilters() {
      isReadLaterFilter = false;
      currentCategoryFilter = null;
      currentSourceFilter = null;
      searchQuery = '';
      const s1 = document.getElementById('search-input'); if (s1) s1.value = '';
      const s2 = document.getElementById('mobile-search-input'); if (s2) s2.value = '';
      displayLimit = 20;
      updateFilterButtonsUI();
      document.getElementById('view-title').innerText = `最近文章`;
      document.getElementById('view-actions').innerHTML = '';
      renderArticles();
      renderSidebar();
      setTimeout(() => toggleSidebar(false), 20);
    }

    function updateFilterButtonsUI() {
      const allBtn = document.getElementById('all-articles-btn');
      const starBtn = document.getElementById('star-filter-btn');

      // 先移除所有 active
      allBtn.classList.remove('active', 'bg-blue-50', 'text-blue-600');
      starBtn.classList.remove('active', 'bg-blue-50', 'text-blue-600');
      allBtn.classList.add('text-slate-700');
      starBtn.classList.add('text-slate-700');

      if (isReadLaterFilter) {
        starBtn.classList.add('active', 'bg-blue-50', 'text-blue-600');
        starBtn.classList.remove('text-slate-700');
      } else if (!currentCategoryFilter && !currentSourceFilter) {
        allBtn.classList.add('active', 'bg-blue-50', 'text-blue-600');
        allBtn.classList.remove('text-slate-700');
      }
    }

    function toggleManagerCat(cat) {
      if (collapsedManagerCats.has(cat)) collapsedManagerCats.delete(cat);
      else collapsedManagerCats.add(cat);
      renderManagerList();
    }

    function renderManagerList() {
      const list = document.getElementById('manager-list');
      if (!list) return;
      document.getElementById('sub-count-total').innerText = allData.subscriptions.length;
      list.innerHTML = '';

      // 按分類分組
      const groups = {};
      allData.subscriptions.forEach(s => {
        const cat = s.category || '未分類';
        if (!groups[cat]) groups[cat] = [];
        groups[cat].push(s);
      });

      Object.keys(groups).sort().forEach(cat => {
        const isCollapsed = collapsedManagerCats.has(cat);
        const catWrap = document.createElement('div');
        catWrap.className = "mb-4 border border-slate-100 rounded-2xl overflow-hidden bg-white shadow-sm";

        const allInCatSelected = groups[cat].every(s => selectedSubIndices.has(s.index));
        const catHeader = document.createElement('div');
        catHeader.className = "bg-slate-50 px-4 py-3 flex items-center justify-between group border-b border-slate-100";
        catHeader.innerHTML = `
          <div class="flex items-center space-x-3 flex-1">
            <input type="checkbox" class="cat-checkbox rounded text-blue-500 scale-90" 
                   ${allInCatSelected ? 'checked' : ''} 
                   onclick="toggleManagerCatSelection('${cat}', this.checked)">
            <div class="flex items-center space-x-2 flex-1 cursor-pointer" onclick="toggleManagerCat('${cat}')">
              <i class="fa-solid ${isCollapsed ? 'fa-folder' : 'fa-folder-open'} text-slate-400"></i>
              <span class="text-sm font-bold text-slate-700">${cat}</span>
              <span class="text-[10px] text-slate-400 bg-white px-2 py-0.5 rounded-full border border-slate-100">${groups[cat].length}</span>
            </div>
          </div>
          <div class="flex items-center space-x-2">
            <button onclick="handleSyncCategory('${cat}', this)" class="text-slate-300 hover:text-blue-500 transition-all p-1" title="重整整個資料夾的文章">
              <i class="fa-solid fa-rotate text-[10px]"></i>
            </button>
            <button onclick="handleRenameCat('${cat}')" class="text-slate-300 hover:text-blue-500 transition-colors opacity-0 group-hover:opacity-100 p-1"><i class="fa-solid fa-pen-to-square text-[10px]"></i></button>
            <button onclick="handleDeleteCat('${cat}')" class="text-slate-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100 p-1"><i class="fa-solid fa-trash-can text-[10px]"></i></button>
            <i class="fa-solid fa-chevron-down text-[10px] text-slate-300 transform ${isCollapsed ? '-rotate-90' : ''} ml-2"></i>
          </div>
        `;
        catWrap.appendChild(catHeader);

        if (!isCollapsed) {
          const itemGrid = document.createElement('div');
          itemGrid.className = "divide-y divide-slate-50";

          groups[cat].forEach(s => {
            const isSelected = selectedSubIndices.has(s.index);
            const isError = s.status && s.status !== 'OK' && s.status !== 'New' && s.status !== 'Updated';
            const div = document.createElement('div');
            div.className = `flex items-center justify-between p-4 bg-white transition-all hover:bg-slate-50/50 ${isSelected ? 'bg-blue-50' : ''}`;
            div.innerHTML = `
              <div class="flex items-center flex-1 min-w-0 pr-2">
                <input type="checkbox" class="sub-checkbox mr-3 md:mr-4 rounded text-blue-600 flex-shrink-0" ${isSelected ? 'checked' : ''} 
                       onclick="event.stopPropagation(); toggleSubSelection(${s.index})">
                <div class="truncate flex-1 min-w-0">
                  <div class="flex items-center space-x-2">
                    <div class="font-bold text-slate-800 text-sm truncate max-w-[120px] md:max-w-none" title="${s.name}">${s.name}</div>
                    ${isError
                ? `<i id="sync-icon-${s.index}" class="fa-solid fa-circle-exclamation text-red-500 text-sm flex-shrink-0 cursor-pointer animate-pulse hover:scale-125 transition-transform" 
                     title="${s.status} - 點擊嘗試重新同步"
                     onclick="event.stopPropagation(); handleSyncSingleSource('${s.name.replace(/'/g, "\\'")}', this)"></i>`
                : `<div class="flex items-center space-x-2">
                     <span class="hidden md:inline-block text-[9px] px-1.5 py-0.5 rounded border bg-slate-50 text-slate-400 border-slate-100">${s.status || 'OK'}</span>
                     <i id="sync-icon-${s.index}" class="fa-solid ${pendingSyncSources.has(s.index) ? 'fa-clock-rotate-left text-amber-500 animate-pulse' : 'fa-rotate-right text-slate-300'} text-xs hover:text-blue-500 cursor-pointer transition-all"
                        onclick="event.stopPropagation(); handleSyncSingleSource('${s.name.replace(/'/g, "\\'")}', this)"
                        title="${pendingSyncSources.has(s.index) ? '上次同步中斷，點擊續傳' : '點擊立即重新同步'}"></i>
                   </div>`
              }
                    <button onclick="event.stopPropagation(); handleToggleFullFetch(${s.index}, ${!s.fullFetch})" 
                            class="ml-2 px-2 py-0.5 rounded-md text-[9px] font-bold transition-all ${s.fullFetch ? 'bg-blue-600 text-white shadow-sm' : 'bg-slate-100 text-slate-400 hover:bg-slate-200'}"
                            title="${s.fullFetch ? '已開啟全文抓取' : '點擊開啟全文抓取'}">
                      <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>全文
                    </button>
                    <button onclick="event.stopPropagation(); handleToggleFreeze(${s.index}, ${!s.isFrozen})" 
                            class="ml-1 px-2 py-0.5 rounded-md text-[9px] font-bold transition-all ${s.isFrozen ? 'bg-blue-200 text-blue-700 shadow-sm' : 'bg-slate-100 text-slate-400 group-hover:text-slate-400 hover:bg-slate-200'}"
                            title="${s.isFrozen ? '已放入冷凍庫 (每週巡邏)' : '放入冷凍庫 (長期不更)'}">
                      <i class="fa-solid fa-snowflake mr-1"></i>冷凍
                    </button>
                  </div>
                  <div class="text-[10px] text-slate-400 truncate mt-0.5 flex items-center">
                    <span class="truncate mr-2 max-w-[140px] md:max-w-xs opacity-80">${s.url}</span>
                    <span class="shrink-0 opacity-60 hidden md:flex items-center"><i class="fa-regular fa-clock mr-1"></i>${s.lastChecked || '-'}</span>
                  </div>
                </div>
              </div>
              <div class="flex items-center space-x-1 shrink-0 ml-1">
                <button onclick="handleEditSub(${s.index}, '${s.name.replace(/'/g, "\\'")}', '${s.url.replace(/'/g, "\\'")}', '${(s.category || '未分類').replace(/'/g, "\\'")}')" class="btn-icon hover:text-blue-500 p-2"><i class="fa-solid fa-pen text-xs"></i></button>
                <button onclick="handleDeleteSub(${s.index})" class="btn-icon hover:text-red-500 p-2"><i class="fa-solid fa-trash text-xs"></i></button>
              </div>
            `;
            itemGrid.appendChild(div);
          });
          catWrap.appendChild(itemGrid);
        }
        list.appendChild(catWrap);
      });
      updateBatchUI();
    }

    function toggleSubSelection(index) {
      if (selectedSubIndices.has(index)) selectedSubIndices.delete(index);
      else selectedSubIndices.add(index);
      updateBatchUI();
    }

    function toggleSelectAll(el) {
      if (el.checked) {
        allData.subscriptions.forEach(s => selectedSubIndices.add(s.index));
      } else {
        selectedSubIndices.clear();
      }
      renderManagerList();
    }

    function clearSelection() {
      selectedSubIndices.clear();
      document.getElementById('select-all').checked = false;
      renderManagerList();
    }

    function updateBatchUI() {
      const bar = document.getElementById('batch-actions');
      const countEl = document.getElementById('selected-count');
      if (selectedSubIndices.size > 0) {
        bar.classList.remove('hidden');
        countEl.innerText = `已選擇 ${selectedSubIndices.size} 項`;
      } else {
        bar.classList.add('hidden');
      }
    }

    async function handleBatchDelete() {
      if (!confirm(`確定要刪除這 ${selectedSubIndices.size} 個訂閱來源嗎？`)) return;

      const indices = Array.from(selectedSubIndices);
      selectedSubIndices.clear();
      try {
        const res = await callApi('batchDeleteSubscriptions', { rowIndices: indices });
        if (res.success) {
          showToast("已成功批次刪除");
          refreshAll();
        }
      } catch (e) {
        console.error("Batch delete failed", e);
      }
    }

    function handleBatchMove() {
      if (selectedSubIndices.size === 0) return;
      updateCategoryDropdown();
      const m = document.getElementById('batch-move-modal');
      const select = document.getElementById('batch-move-cat');
      select.value = '未分類';
      checkNewCategory(select, 'batch-move-cat-custom-wrap');

      m.classList.remove('opacity-0', 'pointer-events-none');
      m.querySelector('div.transform').classList.remove('scale-95');
      m.querySelector('div.transform').classList.add('scale-100');
    }

    function closeBatchMoveModal() {
      const m = document.getElementById('batch-move-modal');
      m.classList.add('opacity-0', 'pointer-events-none');
      m.querySelector('div.transform').classList.remove('scale-100');
      m.querySelector('div.transform').classList.add('scale-95');
    }

    async function handleToggleFullFetch(index, enabled) {
      try {
        const res = await callApi('toggleFullFetch', { rowIndex: index, enabled });
        if (res.success) {
          const sub = allData.subscriptions.find(s => s.index == index);
          if (sub) sub.fullFetch = enabled;
          renderManagerList();
        }
      } catch (e) { }
    }

    async function handleToggleFreeze(index, isFrozen) {
      try {
        const res = await callApi('toggleFreezeSource', { index, isFrozen });
        if (res.success) {
          const sub = allData.subscriptions.find(s => s.index == index);
          if (sub) sub.isFrozen = isFrozen;
          renderManagerList();
          renderSidebar();
        }
      } catch (e) { }
    }
    async function submitBatchMove() {
      const indices = Array.from(selectedSubIndices);
      if (indices.length === 0) {
        showToast("請先選擇要移動的項目", "error");
        return;
      }

      const newCat = getCategoryValue('batch-move-cat');
      closeBatchMoveModal();
      showToast("正在批次更新分類...");

      try {
        const res = await callApi('batchUpdateSubscriptionCategory', { indices, newCat });
        if (res.success) {
          showToast("批次移動完成", "success");
          selectedSubIndices.clear();
          refreshAll();
        } else {
          showToast(res.message || "移動失敗", "error");
        }
      } catch (err) {
        console.error("Batch move failed", err);
        showToast("網路錯誤", "error");
      }
    }

    function handleExportClick() {
      const selections = Array.from(selectedSubIndices);

      if (selections.length > 0) {
        // 有勾選，詢問是否僅匯出勾選項
        if (confirm(`已勾選 ${selections.length} 個來源。是否僅匯出這些項目？\n(點擊「取消」則匯出全部)`)) {
          executeExport({ indices: selections });
          return;
        }
      }

      // 未勾選或選擇不匯出全選
      executeExport({});
    }

    async function executeExport(options) {
      showToast("正在準備匯出 OPML...");
      try {
        const res = await callApi('exportSubscriptions', { options: JSON.stringify(options) }, false);
        if (res.success) {
          const blob = new Blob([res.opml], { type: 'text/xml' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `RSS_Subscriptions_${new Date().toISOString().split('T')[0]}.opml`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          showToast(`匯出成功！支援標準 OPML 規格 (共 ${res.count} 項)`);
        }
      } catch (e) {
        console.error("Export failed", e);
      }
    }

    function handleImportFile(input) {
      const file = input.files[0];
      if (!file) return;

      const targetCatEl = document.getElementById('import-target-category');
      let targetCat = targetCatEl.value;

      if (targetCat === 'NEW') {
        const newCat = prompt("請輸入匯入目標的新分類名稱：");
        if (!newCat) {
          input.value = "";
          return;
        }
        targetCat = newCat;
      }

      const reader = new FileReader();
      reader.onload = async function (e) {
        const xml = e.target.result;
        const msg = targetCat ? `將所有項目匯入到資料夾「${targetCat}」嗎？` : `確認匯入此 OPML 檔案嗎？系統會自動依原有分類匯入。`;

        if (confirm(msg)) {
          showToast("正在匯入 OPML，請稍候...");
          try {
            const res = await callApi('importSubscriptions', { xmlString: xml, targetCategory: targetCat });
            if (res.success) {
              showToast(res.message, "success");
              refreshAll();
              callApi('manualSync', {});
            }
          } catch (err) {
            console.error("Import failed", err);
          }
        }
        input.value = "";
      };
      reader.readAsText(file);
    }

    function toggleManagerCatSelection(cat, checked) {
      allData.subscriptions.forEach(s => {
        if ((s.category || '未分類') === cat) {
          if (checked) selectedSubIndices.add(s.index);
          else selectedSubIndices.delete(s.index);
        }
      });
      renderManagerList();
    }

    function toggleImportExport() {
      const area = document.getElementById('import-export-area');
      const text = document.getElementById('import-export-toggle-text');
      const icon = document.getElementById('import-export-toggle-icon');
      const isHidden = area.classList.contains('hidden');

      if (isHidden) {
        area.classList.remove('hidden');
        text.innerText = "收合進階管理";
        icon.classList.add('rotate-180');
      } else {
        area.classList.add('hidden');
        text.innerText = "開啟匯入匯出";
        icon.classList.remove('rotate-180');
      }
    }

    /**
     * 同步特定分類下的所有來源 (改為客戶端分段執行，避免 GAS 逾時)
     */
    async function handleSyncCategory(catName, btn) {
      if (btn.disabled) return;

      const subsInCat = allData.subscriptions.filter(s => (s.category || '未分類') === catName);
      if (subsInCat.length === 0) {
        showToast("此分類沒有訂閱來源");
        return;
      }

      const sidebarIcon = document.getElementById(`sidebar-cat-sync-${catName.replace(/\s+/g, '-')}`);
      const icon = btn.tagName === 'I' ? btn : btn.querySelector('i');

      const originalClass = icon ? icon.className : "fa-solid fa-rotate";

      // 如果點擊的是 SPAN (數字)，將內容改為旋轉圖示並移除藍底樣式
      const updateIconToSpin = (el) => {
        if (!el) return;
        if (el.tagName === 'SPAN') {
          el.classList.remove('bg-blue-100', 'bg-blue-200', 'px-1.5', 'py-0.5', 'text-blue-600');
          el.classList.add('text-slate-400'); // 改為淡灰色以配合旋轉
          el.innerHTML = '<i class="fa-solid fa-rotate fa-spin"></i>';
        } else {
          el.className = "fa-solid fa-rotate fa-spin text-blue-500 opacity-100";
        }
      };

      updateIconToSpin(btn);
      if (sidebarIcon && sidebarIcon !== btn) updateIconToSpin(sidebarIcon);

      btn.disabled = true;

      showToast(`準備同步資料夾「${catName}」 (共 ${subsInCat.length} 個來源)...`, "info");

      // [新增] 只將「非冷凍」來源加入 pending
      subsInCat.filter(s => !s.isFrozen).forEach(s => pendingSyncSources.add(s.index));
      savePendingSync();

      let successCount = 0;
      let totalNewArticles = 0;
      let errorCount = 0;

      // 使用 for 迴圈序列執行，避免同時發送過多請求
      for (let i = 0; i < subsInCat.length; i++) {
        const sub = subsInCat[i];

        // [智慧冷凍庫] 跳過已冷凍項目
        if (sub.isFrozen) {
          continue;
        }

        btn.title = `正在同步 (${i + 1}/${subsInCat.length}): ${sub.name}`;

        // [優化] 找出清單中「所有」對應的圖示 (側欄 + 管理員清單) 並讓它們轉動
        const subIcons = [
          document.getElementById(`sync-icon-${sub.index}`),
          document.getElementById(`sidebar-sync-icon-${sub.index}`)
        ].filter(el => el);

        subIcons.forEach(icon => {
          if (icon.tagName === 'SPAN') {
            icon.classList.remove('bg-blue-100', 'bg-blue-200', 'px-1.5', 'py-0.5', 'text-blue-600');
            icon.classList.add('text-slate-400');
            icon.innerHTML = '<i class="fa-solid fa-rotate fa-spin"></i>';
          } else {
            icon.className = "fa-solid fa-rotate fa-spin text-[10px] text-blue-500";
          }
        });

        try {
          const res = await callApi('syncSingleSource', { name: sub.name }, true, true);

          if (res.success) {
            successCount++;
            totalNewArticles += res.newArticles;
            subIcons.forEach(icon => {
              if (icon.tagName === 'SPAN') {
                icon.innerHTML = '';
              } else {
                icon.className = "fa-solid fa-rotate-right text-slate-300 text-[10px]";
              }
            });
          } else {
            errorCount++;
            subIcons.forEach(icon => {
              if (icon.tagName === 'SPAN') icon.innerHTML = '<i class="fa-solid fa-exclamation text-red-500"></i>';
              else icon.className = "fa-solid fa-circle-exclamation text-red-500 text-[10px]";
            });
          }
        } catch (err) {
          errorCount++;
          subIcons.forEach(icon => {
            if (icon.tagName === 'SPAN') icon.innerHTML = '<i class="fa-solid fa-exclamation text-red-500"></i>';
            else icon.className = "fa-solid fa-circle-exclamation text-red-500 text-[10px]";
          });
        } finally {
          pendingSyncSources.delete(Number(sub.index));
          savePendingSync();
        }

        // 每完成一個，如果是最後一個或每隔幾個，可以給個小提示
        if ((i + 1) % 5 === 0 && i < subsInCat.length - 1) {
          showToast(`進度: ${i + 1}/${subsInCat.length}...`, "info");
        }
      }

      if (icon) icon.className = originalClass;
      if (sidebarIcon && sidebarIcon !== icon) sidebarIcon.className = originalClass.replace('text-blue-500', '').replace('opacity-100', '');
      btn.disabled = false;
      btn.title = "重整整個資料夾的文章";

      if (errorCount === 0) {
        showToast(`「${catName}」同步完成！共更新 ${totalNewArticles} 則新文章`, "success");
      } else {
        showToast(`「${catName}」同步結束。成功: ${successCount}, 失敗: ${errorCount}。新增 ${totalNewArticles} 則`, errorCount > successCount ? "error" : "success");
      }

      refreshAll(); // 最後才刷新 UI
    }

    /**
     * 同步單一來源
     */
    function handleSyncSingleSource(name, btn) {
      const sub = allData.subscriptions.find(s => s.name === name);
      if (!sub) return;

      const subIcons = [
        document.getElementById(`sync-icon-${sub.index}`),
        document.getElementById(`sidebar-sync-icon-${sub.index}`)
      ].filter(el => el);

      subIcons.forEach(icon => {
        if (icon.tagName === 'SPAN') {
          icon.innerHTML = '<i class="fa-solid fa-rotate fa-spin"></i>';
        } else {
          icon.className = "fa-solid fa-rotate fa-spin text-[10px] text-blue-500";
        }
      });

      // 單一同步也同步更新 Pending 狀態 (強制轉 Number)
      pendingSyncSources.add(Number(sub.index));
      savePendingSync();

      callApi('syncSingleSource', { name }).then(res => {
        // 不論成功失敗，RPC 回傳後即移除 Pending
        pendingSyncSources.delete(Number(sub.index));
        savePendingSync();

        if (res.success) {
          refreshAll();
        } else {
          showToast(res.message, "error");
          subIcons.forEach(icon => {
            if (icon.tagName === 'SPAN') icon.innerHTML = '<i class="fa-solid fa-exclamation text-red-500"></i>';
            else icon.className = "fa-solid fa-circle-exclamation text-red-500 text-[10px]";
          });
        }
      }).catch(err => {
        showToast("網路錯誤: " + err, "error");
        subIcons.forEach(icon => {
          if (icon.tagName === 'SPAN') icon.innerHTML = '<i class="fa-solid fa-exclamation text-red-500"></i>';
          else icon.className = "fa-solid fa-circle-exclamation text-red-500 text-[10px]";
        });
      });
    }

    async function handleRenameCat(oldCat) {
      const newName = prompt(`將分類「${oldCat}」重新命名為：`, oldCat);
      if (!newName || newName === oldCat) return;
      showToast("正在重新命名...");
      try {
        const res = await callApi('renameCategory', { oldCat, newCat: newName });
        if (res.success) {
          showToast("分類已重命名");
          refreshAll();
        }
      } catch (e) { }
    }

    async function handleDeleteCat(cat) {
      if (!confirm(`確定要刪除分類「${cat}」及其包含的所有訂閱嗎？此動作無法復原。`)) return;
      showToast("正在刪除分類...");
      try {
        const res = await callApi('deleteCategorySubscriptions', { category: cat });
        if (res.success) {
          showToast("分類及相關訂閱已刪除");
          refreshAll();
        }
      } catch (e) { }
    }

    function handleToggleStar(articleId, el) {
      const isStarred = allData.starredIds.has(articleId);
      updateStarStatus(articleId, !isStarred, el);
    }

    // [新增] 統一管理星號/收藏狀態
    function updateStarStatus(articleId, shouldStar, specificEl) {
      if (shouldStar) {
        allData.starredIds.add(articleId);
      } else {
        allData.starredIds.delete(articleId);
      }

      // 1. 更新主畫面中的圖示 (網格與列表)
      const mainButtons = document.querySelectorAll(`[onclick*="handleToggleStar('${articleId}'"]`);
      mainButtons.forEach(btn => {
        if (shouldStar) {
          btn.className = "fa-solid fa-star text-amber-400 cursor-pointer text-[12px] md:text-[13px]";
        } else {
          btn.className = "fa-regular fa-star text-slate-300 hover:text-amber-400 cursor-pointer text-[12px] md:text-[13px]";
        }
      });

      // 2. 更新佇列中的圖示 (雖然佇列常用移除按鈕代替星號，但保持一致性)
      // 如果將來佇列有星號，這裡可添加 logic

      // 3. 同步至後端
      callApi('toggleStar', { id: articleId, shouldStar }, true, 'toast');

      // 更新側邊欄進度
      renderSidebar();
    }

    let _cachedFilteredArticles = null;
    let _lastFilterKey = "";

    function getFilteredArticles() {
      // 建立一個與過濾參數相關的 Key，若參數沒變且快取存在則直接回傳
      const filterKey = `${showUnreadOnly}_${currentSourceFilter}_${currentCategoryFilter}_${isReadLaterFilter}_${searchQuery}_${allData.readIds.size}_${allData.starredIds.size}`;

      if (_cachedFilteredArticles && _lastFilterKey === filterKey) {
        return _cachedFilteredArticles;
      }

      let filtered = (allData.articles || []).filter(a => {
        if (isReadLaterFilter) return allData.starredIds.has(a.id);
        return true;
      });

      if (currentSourceFilter) {
        filtered = filtered.filter(a => a.source === currentSourceFilter);
      } else if (currentCategoryFilter) {
        const sourceNames = allData.subscriptions
          .filter(s => (s.category || '未分類') === currentCategoryFilter)
          .map(s => s.name);
        const sourceSet = new Set(sourceNames);
        filtered = filtered.filter(a => sourceSet.has(a.source));
      }

      if (showUnreadOnly && !isReadLaterFilter) {
        filtered = filtered.filter(a => !allData.readIds.has(a.id));
      }

      if (searchQuery) {
        const q = searchQuery.toLowerCase();
        filtered = filtered.filter(a => {
          if ((a.title || "").toLowerCase().indexOf(q) !== -1) return true;
          if ((a.source || "").toLowerCase().indexOf(q) !== -1) return true;
          return (a.description || "").substring(0, 500).toLowerCase().indexOf(q) !== -1;
        });
      }

      // 文章已經在 refreshAll 預先排序好了，這裡只需快取結果
      _cachedFilteredArticles = filtered;
      _lastFilterKey = filterKey;
      return filtered;
    }

    function formatRelativeTime(dateInput) {
      if (!dateInput) return '最新';
      const date = new Date(dateInput);
      if (isNaN(date.getTime())) return '最新';

      const now = new Date();
      const diffMs = now - date;
      const diffMin = Math.floor(diffMs / (1000 * 60));
      const diffHr = Math.floor(diffMs / (1000 * 60 * 60));

      if (diffMin < 1) return 'now';
      if (diffMin < 60) return `${diffMin}min`;
      if (diffHr < 24) return `${diffHr}h`;

      // 超過一天顯示日期
      return date.toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' });
    }

    function getAudioControlsHtml(a) {
      if (!a || !a.audioUrl) return '';
      const isInQueue = (allData.queue || []).some(it => it.id === a.id);
      const queueIcon = isInQueue ? 'fa-minus' : 'fa-plus';
      const queueTitle = isInQueue ? '從佇列移除' : '加入播放佇列';
      const queueAction = isInQueue ? `removeFromQueueByElement('${a.id}')` : `addToQueue('${a.id}')`;

      return `
          <button onclick="event.stopPropagation(); initPlayerById('${a.id}', true)" 
                  class="text-slate-400 hover:text-blue-600 transition-colors p-1" title="立即播放">
            <i class="fa-solid fa-circle-play text-[17px]"></i>
          </button>
          <button onclick="event.stopPropagation(); handleToggleQueue('${a.id}')" 
                  class="text-slate-400 hover:text-blue-600 transition-colors p-1" title="${queueTitle}">
            <i class="fa-solid ${queueIcon} text-[15px]"></i>
          </button>
      `;
    }

    function getLinkHtml(a, isListMode) {
      if (!a) return '';
      // 確保連結始終存在，如果沒有則使用 # (避免 icon 不見)
      const href = a.link || '#';
      return `
        <a href="${href}" target="_blank" onclick="event.stopPropagation(); markAsReadInline('${a.id}')" 
           class="text-slate-500 hover:text-blue-600 transition-colors p-1 flex-shrink-0" 
           title="原文連結">
          <i class="fa-solid fa-arrow-up-right-from-square ${isListMode ? 'text-[15px]' : 'text-[13px]'}"></i>
        </a>
      `;
    }

    function getAiButtonHtml(a) {
      if (!a || !a.audioUrl) return '';
      const hasAi = a.aiSummary || a.transcript;
      const sparkleClass = hasAi ? 'grayscale-0 text-amber-500' : 'grayscale text-slate-400 opacity-60';
      return `
        <button onclick="event.stopPropagation(); handleGenerateAI('${a.id}', this)" 
                class="ai-sparkle-btn p-1 ${sparkleClass}" 
                title="${hasAi ? '查看 AI 筆記' : '生成 AI 筆記'}">
          <i class="fa-solid fa-wand-magic-sparkles text-[15px]"></i>
        </button>
      `;
    }

    function renderArticles() {
      const grid = document.getElementById('grid');
      const countEl = document.getElementById('article-count');
      const emptyEl = document.getElementById('empty-state');
      const loader = document.getElementById('loader');

      const filtered = getFilteredArticles();
      const displayed = filtered.slice(0, displayLimit);

      const filterText = isReadLaterFilter ? "稍候閱讀" : (currentSourceFilter || "最近一個月文章");
      countEl.innerText = `共 ${displayed.length} / ${filtered.length} 則文章`;

      // 隱藏載入動畫，顯示網格
      if (loader) loader.classList.add('hidden');
      grid.classList.remove('hidden');
      if (emptyEl) emptyEl.classList.add('hidden');

      grid.innerHTML = '';
      const fragment = document.createDocumentFragment();

      if (filtered.length === 0) {
        grid.innerHTML = `
          <div class="col-span-full py-32 flex flex-col items-center justify-center text-center">
            <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mb-6 border border-slate-100">
               <i class="fa-solid fa-wind text-3xl text-slate-300"></i>
            </div>
            <h3 class="text-slate-400 font-bold mb-2">空空如也</h3>
            <p class="text-slate-300 text-sm max-w-[200px] leading-relaxed">選取的視圖下目前沒有任何文章內容</p>
          </div>
        `;
        return;
      }

      const isListMode = displayMode === 'list';
      if (!isListMode) {
        grid.className = "grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6";
        displayed.forEach(a => {
          const isRead = allData.readIds.has(a.id);
          const isStarred = allData.starredIds.has(a.id);
          const card = document.createElement('div');
          card.setAttribute('data-id', a.id);
          card.className = `article-card bg-white p-5 rounded-xl border border-slate-200 shadow-sm transition-all cursor-pointer flex flex-col h-full ${isRead ? 'is-read' : ''}`;
          card.onclick = () => openFullContentModal(a.id, card);
          const dateStr = formatRelativeTime(a.date);
          const plainDesc = (a.description || "").replace(/<[^>]+>/g, '').substring(0, 150);
          const actionButtons = ""; // Not used anymore

          card.innerHTML = `
            <div class="flex justify-between items-center mb-2 flex-nowrap">
              <div class="flex items-center min-w-0 flex-1 mr-2 space-x-2">
                <span onclick="event.stopPropagation(); setSourceFilter('${a.source}')" 
                      class="text-[9px] font-bold text-blue-500 uppercase tracking-wider bg-blue-50 px-1.5 py-0.5 rounded truncate cursor-pointer hover:bg-blue-100 transition-colors leading-none">${a.source}</span>
                <span class="text-[10px] font-medium text-slate-400 whitespace-nowrap">${dateStr}</span>
              </div>
              <div class="flex items-center space-x-2 flex-shrink-0 flex-nowrap">
                <i onclick="event.stopPropagation(); handleToggleStar('${a.id}', this)" 
                   class="${isStarred ? 'fa-solid fa-star text-amber-400' : 'fa-regular fa-star text-slate-300 hover:text-amber-400'} cursor-pointer text-[12px]"></i>
                <div onclick="event.stopPropagation(); toggleReadStatus('${a.id}', this.closest('.article-card'))" class="w-4 h-4 flex items-center justify-center cursor-pointer">
                    ${!isRead ? '<span class="h-1.5 w-1.5 bg-blue-500 rounded-full shadow-lg shadow-blue-200 animate-pulse"></span>' : '<div class="h-1.5 w-1.5 border border-slate-300 rounded-full hover:bg-slate-200 transition-colors"></div>'}
                </div>
              </div>
            </div>
            <h3 class="text-base font-bold text-slate-800 mb-1 line-clamp-2 hover:text-blue-600 transition-colors leading-snug">${a.title}</h3>
            <p class="text-[13px] text-slate-500 line-clamp-3 mb-2 text-justify leading-relaxed opacity-90">${plainDesc}...</p>
            <div class="flex justify-end items-center mt-auto border-t border-slate-50 pt-1.5 w-full space-x-1.5">
                ${getAiButtonHtml(a)}
                ${getAudioControlsHtml(a)}
                ${getLinkHtml(a, false)}
            </div>
          `;
          fragment.appendChild(card);
        });
      } else {
        grid.className = "flex flex-col max-w-6xl mx-auto w-full is-list-mode space-y-1";
        displayed.forEach(a => {
          const isRead = allData.readIds.has(a.id);
          const isStarred = allData.starredIds.has(a.id);
          const item = document.createElement('div');
          item.setAttribute('data-id', a.id);
          item.className = `list-view-item cursor-pointer ${isRead ? 'is-read' : ''}`;
          item.onclick = () => openFullContentModal(a.id, item);
          const dateStr = formatRelativeTime(a.date);
          const audioControls = getAudioControlsHtml(a);
          const aiButton = getAiButtonHtml(a);
          const linkHtml = getLinkHtml(a, true);

          item.innerHTML = `
               <div class="flex items-start w-full gap-2.5">
                  <!-- Unread Dot -->
                  <div class="flex-shrink-0 flex items-start justify-center w-2.5 mt-[5px]">
                     ${!isRead ? '<div class="unread-dot h-2 w-2 bg-blue-500 rounded-full shadow-sm"></div>' : ''}
                  </div>

                  <!-- Content Area -->
                  <div class="flex-1 min-w-0">
                     <!-- Row 1: Title & Date -->
                     <div class="flex justify-between items-start mb-1 gap-4">
                        <h3 class="text-[14px] font-bold text-slate-800 leading-tight line-clamp-2 transition-colors hover:text-blue-600">${a.title}</h3>
                        <span class="text-[10px] font-medium text-slate-400 whitespace-nowrap opacity-70">${dateStr}</span>
                     </div>
                     
                     <!-- Row 2: Metadata & Actions -->
                     <div class="flex items-center justify-between mt-1 flex-nowrap">
                        <!-- Left: Source Badge -->
                        <span onclick="event.stopPropagation(); setSourceFilter('${a.source}')" 
                              class="text-[9px] font-bold text-blue-500 uppercase tracking-wider bg-blue-50 px-1.5 py-0.5 rounded truncate max-w-[120px] cursor-pointer hover:bg-blue-100 transition-colors leading-none">${a.source}</span>
                        
                        <!-- Right: Actions Group -->
                        <div class="flex items-center space-x-2.5 flex-nowrap">
                           ${aiButton}
                           ${audioControls}
                           ${linkHtml}
                           <i onclick="event.stopPropagation(); handleToggleStar('${a.id}', this)" 
                              class="${isStarred ? 'fa-solid fa-star text-amber-400 text-[13px]' : 'fa-regular fa-star text-slate-200 text-[13px]'} cursor-pointer hover:text-amber-400 transition-colors"></i>
                        </div>
                     </div>
                  </div>
               </div>
          `;

          fragment.appendChild(item);
        });
      }
      grid.appendChild(fragment);

      // 如果還有更多文章，顯示暗示
      if (displayLimit < filtered.length) {
        const more = document.createElement('div');
        more.className = "col-span-full py-10 text-center text-slate-400 text-xs flex flex-col items-center";
        more.innerHTML = `
          <div class="w-1 h-1 bg-slate-200 rounded-full mb-1"></div>
          <div class="w-1 h-1 bg-slate-200 rounded-full mb-1"></div>
          <div class="w-1 h-1 bg-slate-200 rounded-full mb-4"></div>
          <span>向下捲動載入更多...</span>
        `;
        grid.appendChild(more);
      } else {
        const end = document.createElement('div');
        end.className = "col-span-full py-10 text-center text-slate-300 text-[10px] tracking-widest uppercase";
        end.innerText = "— 已顯示所有文章 —";
        grid.appendChild(end);
      }
    }

    function toggleSummary(el, articleId) {
      el.classList.toggle('is-expanded');
      // 展開摘要也視同已讀 (依照一般 RSS 閱讀器邏輯)
      if (el.classList.contains('is-expanded')) {
        markAsReadInline(articleId, el);
      }
    }

    function markAsReadInline(articleId, el) {
      if (!allData.readIds.has(articleId)) {
        allData.readIds.add(articleId);

        // 如果沒傳入 el，嘗試根據 data-id 找到它
        if (!el) {
          el = document.querySelector(`[data-id="${articleId}"]`);
        }

        if (el) {
          el.classList.add('is-read');
          // 重新抓取 dot container 內的內容以確保顯示正確
          const dotContainer = el.querySelector('[title="切換已讀/未讀"]');
          if (dotContainer) {
            dotContainer.innerHTML = '<div class="h-2 w-2 border border-slate-300 rounded-full hover:bg-slate-200 transition-colors"></div>';
          }
        }

        renderSidebar(); // 更新側邊欄計數
        callApi('markAsRead', { id: articleId }, true, true);
      }
    }

    function toggleReadStatus(articleId, el) {
      const isRead = allData.readIds.has(articleId);
      const newStatus = !isRead;

      if (newStatus) {
        allData.readIds.add(articleId);
        el.classList.add('is-read');
      } else {
        allData.readIds.delete(articleId);
        el.classList.remove('is-read');
      }

      // 更新圓點 UI
      const dotContainer = el.querySelector('[title="切換已讀/未讀"]');
      if (dotContainer) {
        if (newStatus) {
          dotContainer.innerHTML = '<div class="h-2 w-2 border border-slate-300 rounded-full hover:bg-slate-200 transition-colors"></div>';
        } else {
          dotContainer.innerHTML = displayMode === 'grid'
            ? '<span class="h-2 w-2 bg-blue-500 rounded-full shadow-lg shadow-blue-200 animate-pulse"></span>'
            : '<div class="unread-dot animate-pulse"></div>';
        }
      }

      callApi('setReadStatus', { id: articleId, status: newStatus }, true, 'toast');
    }




    function openArticle(link, id, el) {
      window.open(link, '_blank');
      markAsReadInline(id, el);
    }

    function markPageAsRead() {
      // 找出當前過濾條件下的所有結果 (不論是否已載入到畫面上)
      const filtered = getFilteredArticles();
      const unreadArticles = filtered.filter(a => !allData.readIds.has(a.id));

      if (unreadArticles.length === 0) {
        showToast("目前沒有未讀文章", "info");
        return;
      }

      if (!confirm(`確定要將目前篩選條件下的 ${unreadArticles.length} 則未讀文章全部標記為已讀嗎？`)) return;

      const idsToMark = unreadArticles.map(a => a.id);

      // 樂觀更新 UI
      idsToMark.forEach(id => allData.readIds.add(id));
      renderArticles();
      renderSidebar(); // [修正] 全部已讀後更新側邊欄計數
      showToast(`已將 ${idsToMark.length} 則文章標為已讀`);

      // 同步到後端
      callApi('markMultipleAsRead', { ids: idsToMark }, true, 'toast').then(res => {
        if (!res || !res.success) showToast("標記失敗，請稍後再試。", "error");
      });
    }

    function setTimeFilter(days, el) { /* 移除 */ }


    function toggleUnreadFilter() {
      showUnreadOnly = !showUnreadOnly;
      const dot = document.getElementById('unread-dot-indicator');
      if (dot) dot.style.opacity = showUnreadOnly ? '1' : '0.2';

      // 效能優化：不直接 renderArticles()，先透過非同步處理讓 UI 先反應樣式
      requestAnimationFrame(() => {
        renderArticles();
      });
    }

    let searchTimeout = null;
    function handleSearch(val) {
      searchQuery = val.trim();
      const clearBtn = document.getElementById('search-clear-btn');
      if (clearBtn) {
        if (searchQuery) clearBtn.classList.remove('hidden');
        else clearBtn.classList.add('hidden');
      }

      // 效能優化：加入去抖動 (Debounce)，避免輸入時頻繁觸發重繪
      if (searchTimeout) clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        displayLimit = 20; // 搜尋時重設顯示數量
        renderArticles();
      }, 300); // 300ms 延遲
    }

    function clearSearch() {
      const input = document.getElementById('search-input');
      if (input) input.value = "";
      handleSearch("");
    }

    function openFullContentModal(articleId, el) {
      const a = allData.articles.find(item => item.id === articleId);
      if (!a) return;

      const modalBody = document.getElementById('modal-body-text');
      document.getElementById('modal-title').innerText = a.title;
      document.getElementById('modal-source').innerText = a.source + ' • ' + formatDate(a.date);

      // 修正潛在的逸脫字元問題 (針對先前生成的舊資料或解析例外)
      let summaryContent = a.aiSummary || '';
      if (summaryContent.includes('\\n')) {
        summaryContent = summaryContent.replace(/\\n/g, '\n');
      }

      const toggleWrap = document.getElementById('modal-header-toggle');
      if (toggleWrap) {
        toggleWrap.innerHTML = summaryContent ? `
          <div class="pill-toggle-container scale-[0.85] md:scale-100 origin-left">
            <button onclick="switchTab('full')" id="tab-full" class="pill-toggle-btn active">內容</button>
            <button onclick="switchTab('summary')" id="tab-summary" class="pill-toggle-btn inactive">AI 筆記</button>
          </div>
        ` : '';
      }

      // 更新 Header 動作按鈕
      const headerActions = document.getElementById('modal-header-actions');
      if (headerActions) {
        headerActions.innerHTML = `
          ${getAiButtonHtml(a)}
          ${getAudioControlsHtml(a)}
        `;
      }

      modalBody.innerHTML = `
        <div id="modal-contentWrapper">
          <!-- 內容區塊 -->
          <div id="content-full" class="tab-content article-content-body px-1 prose-sm sm:prose-base">${a.description || '目前沒有全文內容。'}</div>
          <div id="content-summary" class="tab-content hidden prose prose-slate max-w-none px-1 dark:prose-invert">
            ${summaryContent ? marked.parse(summaryContent) : ''}
          </div>
        </div>
      `;


      // 預設頁籤邏輯
      setTimeout(() => {
        if (a.aiSummary) switchTab('summary');
        else switchTab('full');
      }, 0);


      modalBody.scrollTop = 0; // 開啟新文章時強制捲動回最上方
      document.getElementById('modal-date').innerText = `發布時間：${new Date(a.date).toLocaleString('zh-TW')}`;
      document.getElementById('modal-link').href = a.link;
      document.getElementById('modal-link').onclick = () => markAsReadInline(a.id, el);

      // 處理損毀圖片：如果圖片載入失敗，直接隱藏並顯示提示
      const images = modalBody.querySelectorAll('img');
      images.forEach(img => {
        img.onerror = function () {
          this.style.display = 'none'; // 隱藏損毀圖片
          const hint = document.createElement('div');
          hint.className = 'text-[10px] text-slate-400 text-center my-4 italic p-4 bg-slate-50 rounded-lg border border-dashed border-slate-200';
          hint.innerText = '[ 此圖片無法載入，可能來自防盜用連結或已失效 ]';
          this.parentNode.insertBefore(hint, this.nextSibling);
        };
      });

      const modal = document.getElementById('content-modal');
      const body = document.getElementById('content-modal-body');
      modal.classList.remove('opacity-0', 'pointer-events-none');
      body.classList.remove('scale-95');
      body.classList.add('scale-100');
      document.body.style.overflow = 'hidden';

      markAsReadInline(articleId, el);
    }

    function closeContentModal() {
      const modal = document.getElementById('content-modal');
      modal.classList.add('opacity-0');
      modal.classList.add('pointer-events-none');
      document.body.classList.remove('modal-active');
      const body = document.getElementById('content-modal-body');
      body.classList.remove('scale-100');
      body.classList.add('scale-95');
      document.body.style.overflow = '';
    }

    // --- Global Audio Player Logic ---
    function initPlayerById(id, immediatePlay) {
      const a = allData.articles.find(it => it.id === id);
      if (a) initPlayer(a, immediatePlay);
    }

    function initPlayer(article, immediatePlay) {
      const bar = document.getElementById('podcast-player-bar');
      const player = document.getElementById('main-audio-player');
      const title = document.getElementById('player-item-title');
      const subtitle = document.getElementById('player-item-subtitle');

      bar.classList.remove('player-hidden');
      currentPlayingId = article.id;

      // [新增] 自動加入佇列邏輯：如果不在佇列中，加入到頂端 (僅儲存 ID)
      const inQueue = allData.queue.some(qid => qid === article.id);
      if (!inQueue) {
        allData.queue.unshift(article.id);
        syncQueueToServer();
      }

      // [優化] 自動標記「稍後閱讀」與「已讀」
      markAsReadInline(article.id);
      updateStarStatus(article.id, true);

      // If same audio is already playing, just make sure it's playing if requested
      if (player.src === article.audioUrl) {
        if (immediatePlay) {
          player.play();
          if (playerDisplayMode === 'ball') togglePlayerDisplay('bar');
        }
        applyPlayerDisplay();
        renderQueue();
        return;
      }

      player.src = article.audioUrl;

      // 優化跑馬燈：雙層結構實現無縫滾動
      title.innerHTML = `<span class="marquee-span">${article.title}</span>`;
      title.classList.remove('animating');
      title.style.transform = 'none';

      // 檢查是否溢出
      setTimeout(() => {
        const wrap = title.parentElement;
        if (title.scrollWidth > wrap.offsetWidth + 10) {
          title.innerHTML = `<span class="marquee-span">${article.title}</span><span class="marquee-span">${article.title}</span>`;
          title.classList.add('animating');
        }
      }, 100);

      subtitle.innerText = article.source;

      // Update Download Link
      const dlBtn = document.getElementById('player-download-btn');
      if (dlBtn) dlBtn.onclick = () => handleDownload(article.audioUrl, article.title);

      // Restore progress
      const progress = allData.podcastProgress[article.id] || localStorage.getItem('podcast_progress_' + article.id);

      player.playbackRate = currentPlaybackSpeed;
      player.defaultPlaybackRate = currentPlaybackSpeed;

      let seekAttempted = false;
      player.onloadedmetadata = () => {
        player.playbackRate = currentPlaybackSpeed;
        syncSpeedUI(); // 再次確保 UI 同步
        document.getElementById('player-duration').innerText = formatTime(player.duration);
        document.getElementById('player-progress').max = Math.floor(player.duration);

        if (!seekAttempted && progress) {
          player.currentTime = Math.max(0, parseFloat(progress));
          seekAttempted = true;
        }
      };

      player.ontimeupdate = () => {
        if (player.currentTime > 0 && !player.paused) {
          const currentTime = player.currentTime;
          const duration = player.duration;

          // Update UI
          document.getElementById('player-current-time').innerText = formatTime(currentTime);
          const progressInput = document.getElementById('player-progress');
          progressInput.value = Math.floor(currentTime);

          const percent = (currentTime / duration) * 100;
          document.getElementById('player-progress-fill').style.width = percent + '%';

          // Sync logic
          const savePoint = Math.max(0, currentTime - 5);
          allData.podcastProgress[article.id] = savePoint;
          localStorage.setItem('podcast_progress_' + article.id, savePoint);
          debounceSyncProgress();
        }
      };

      player.onplay = () => {
        player.playbackRate = currentPlaybackSpeed;
        updatePlayerUI(true);
        renderQueue();
      };

      player.onpause = () => {
        forceSyncProgress();
        updatePlayerUI(false);
        renderQueue();
      };

      player.onended = () => {
        markAsReadInline(article.id);
        updateStarStatus(article.id, false);
        allData.podcastProgress[article.id] = 0;
        localStorage.removeItem('podcast_progress_' + article.id);
        forceSyncProgress();
        playNextInQueue();
      };

      // Progress Bar Interaction
      const progressInput = document.getElementById('player-progress');
      progressInput.oninput = (e) => {
        const val = e.target.value;
        const duration = player.duration;
        const percent = (val / duration) * 100;
        document.getElementById('player-progress-fill').style.width = percent + '%';
        document.getElementById('player-current-time').innerText = formatTime(val);
      };

      progressInput.onchange = (e) => {
        player.currentTime = e.target.value;
      };

      if (immediatePlay) {
        player.play().catch(e => console.log("Auto-play blocked:", e));
      }

      setTimeout(() => {
        if (playerDisplayMode === 'ball' && immediatePlay) togglePlayerDisplay('bar');
        else applyPlayerDisplay();
        renderQueue();
        syncPlayerStateToCloud();
      }, 0);
    }

    function togglePlayPause() {
      const player = document.getElementById('main-audio-player');
      if (!player || !player.src) return;
      if (player.paused) {
        player.play().catch(e => console.warn("Play failed:", e));
      } else {
        player.pause();
      }
    }

    function formatTime(seconds) {
      if (isNaN(seconds) || seconds === Infinity) return "00:00";
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = Math.floor(seconds % 60);
      if (h > 0) {
        return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
      }
      return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    function updatePlayerUI(isPlaying) {
      const btn = document.getElementById('player-main-btn');
      if (btn) {
        btn.innerHTML = isPlaying ? '<i class="fa-solid fa-pause"></i>' : '<i class="fa-solid fa-play ml-1"></i>';
      }
    }

    function handleDownload(url, title) {
      if (!url) return;
      const link = document.createElement('a');
      link.href = url;
      link.download = (title || 'podcast') + '.mp3';
      link.target = '_blank';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      showToast("開始下載音訊檔案");
    }

    function closePlayer() {
      const bar = document.getElementById('podcast-player-bar');
      const player = document.getElementById('main-audio-player');
      player.pause();
      bar.classList.add('player-hidden');
      document.getElementById('podcast-floating-ball').classList.remove('show');
      currentPlayingId = null;
      renderQueue();
      syncPlayerStateToCloud();
    }

    function togglePlayerDisplay(mode) {
      playerDisplayMode = mode;
      localStorage.setItem('podcast_display_mode', mode);
      applyPlayerDisplay();
      syncPlayerStateToCloud();
    }

    function applyPlayerDisplay() {
      const bar = document.getElementById('podcast-player-bar');
      const ball = document.getElementById('podcast-floating-ball');

      const hasContent = (currentPlayingId || (allData.queue && allData.queue.length > 0));

      if (!hasContent) {
        bar.classList.add('player-hidden');
        ball.classList.remove('show');
        return;
      }

      let effectiveMode = playerDisplayMode;
      if (!currentPlayingId) effectiveMode = 'ball';

      if (effectiveMode === 'ball') {
        bar.classList.add('player-hidden');
        ball.classList.add('show');
      } else {
        bar.classList.remove('player-hidden');
        ball.classList.remove('show');

        const aiBtn = document.getElementById('player-ai-btn');
        if (aiBtn && currentPlayingId) {
          const a = (allData.articles || []).find(it => it.id === currentPlayingId);
          if (a) {
            const hasAi = a.aiSummary || a.transcript;
            if (hasAi) {
              aiBtn.classList.remove('grayscale', 'opacity-60');
              aiBtn.classList.add('grayscale-0', 'text-amber-500', 'opacity-100');
            } else {
              aiBtn.classList.add('grayscale', 'opacity-60');
              aiBtn.classList.remove('grayscale-0', 'text-amber-500', 'opacity-100');
            }
          }
        }
      }
    }

    function syncSpeedUI() {
      const trigger = document.getElementById('speed-trigger');
      if (trigger) trigger.innerText = currentPlaybackSpeed + 'x';

      const menu = document.getElementById('speed-menu');
      if (menu) {
        menu.querySelectorAll('.speed-menu-item').forEach(b => {
          const val = parseFloat(b.innerText);
          b.classList.toggle('active', val === currentPlaybackSpeed);
        });
      }

      const player = document.getElementById('main-audio-player');
      if (player) {
        player.playbackRate = currentPlaybackSpeed;
        player.defaultPlaybackRate = currentPlaybackSpeed;
      }
    }

    function setPlaybackSpeed(speed) {
      currentPlaybackSpeed = speed;
      localStorage.setItem('podcast_speed', speed);
      syncSpeedUI();

      const menu = document.getElementById('speed-menu');
      if (menu) menu.classList.remove('show');

      syncPlayerStateToCloud();
    }

    function skipTime(seconds) {
      const player = document.getElementById('main-audio-player');
      if (player) {
        player.currentTime = Math.max(0, Math.min(player.duration, player.currentTime + seconds));
      }
    }

    function toggleSpeedMenu() {
      const menu = document.getElementById('speed-menu');
      if (menu) menu.classList.toggle('show');
    }

    // --- Cloud Sync Helpers ---
    let syncProgressTimeout = null;
    function debounceSyncProgress() {
      if (syncProgressTimeout) clearTimeout(syncProgressTimeout);
      syncProgressTimeout = setTimeout(() => forceSyncProgress(), 5000); // 縮短為 5 秒
    }

    // [新增] 定時心跳同步：每 30 秒強制同步一次，解決「直接關閉網頁」未觸發暫停同步的問題
    setInterval(() => {
      const player = document.getElementById('main-audio-player');
      if (player && !player.paused && player.currentTime > 0) {
        console.log("Heartbeat sync...");
        forceSyncProgress();
      }
    }, 30000);

    function forceSyncProgress() {
      if (syncProgressTimeout) clearTimeout(syncProgressTimeout);

      // [優化] 同步前清理：移除進度極小或已標記為 0 (結束) 的項目
      const cleanedProgress = {};
      for (const id in allData.podcastProgress) {
        const val = parseFloat(allData.podcastProgress[id]);
        if (val > 10) cleanedProgress[id] = val;
      }
      allData.podcastProgress = cleanedProgress;

      callApi('savePodcastState', { type: 'progress', state: allData.podcastProgress }, true, true);
    }

    // 視窗關閉前嘗試同步
    window.addEventListener('beforeunload', () => forceSyncProgress());

    // [新增] 頁面可見性切換時自動從雲端更新進度 (解決手機/電腦同步延遲)
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        console.log("App visible, refreshing cloud data...");
        // 僅在背景更新資料，不要打斷目前的播放或操作
        callApi('getAllData', {}, false, true).then(res => {
          if (res && res.podcastProgress) {
            // 智慧合併進度：保留各篇文章中最晚的進度
            for (let id in res.podcastProgress) {
              const cloudVal = parseFloat(res.podcastProgress[id]);
              const localVal = parseFloat(allData.podcastProgress[id] || 0);
              // 如果目前正在播放這首，則謹慎更新 (除非雲端明顯領先)
              if (id === currentPlayingId) {
                const player = document.getElementById('main-audio-player');
                if (player && Math.abs(cloudVal - player.currentTime) > 10) {
                  // 暫不自動跳轉，避免嚇到使用者，但更新紀錄
                  allData.podcastProgress[id] = Math.max(cloudVal, player.currentTime);
                }
              } else {
                allData.podcastProgress[id] = Math.max(cloudVal, localVal);
              }
            }
            // 同時更新佇列狀態
            if (res.podcastQueue) allData.queue = res.podcastQueue;
          }
        });
      } else if (document.visibilityState === 'hidden') {
        // [新增] 當進入背景 (例如手機切換 App 或關閉分頁) 時強制同步一次
        console.log("App hidden, forcing sync...");
        forceSyncProgress();
      }
    });

    function syncQueueToServer() {
      callApi('savePodcastState', { type: 'queue', state: allData.queue }, true, true);
    }

    let syncStateTimeout = null;
    function syncPlayerStateToCloud() {
      if (syncStateTimeout) clearTimeout(syncStateTimeout);
      syncStateTimeout = setTimeout(() => {
        const state = {
          currentId: currentPlayingId,
          speed: currentPlaybackSpeed,
          mode: playerDisplayMode
        };
        callApi('savePodcastState', { type: 'playerState', state: state }, true, true);
      }, 5000);
    }

    /* --- Queue System --- */
    function handleToggleQueue(id) {
      const idx = allData.queue.indexOf(id);
      const isRemoving = idx !== -1;

      if (isRemoving) {
        // 從佇列移除
        allData.queue.splice(idx, 1);
        if (id === currentPlayingId) {
          stopPlayer();
          if (allData.queue.length > 0) {
            const nextA = allData.articles.find(it => it.id === allData.queue[0]);
            if (nextA) initPlayer(nextA, true);
          } else {
            currentPlayingId = null;
            applyPlayerDisplay();
            syncPlayerStateToCloud();
          }
        }
        updateStarStatus(id, false); // [新增] 移除佇列自動取消收藏
        showToast("已從播放佇列移除");
      } else {
        // 加入佇列 (僅加入 ID)
        allData.queue.push(id);
        // [新增] 加入佇列自動標記
        markAsReadInline(id);
        updateStarStatus(id, true);
        showToast("已加入播放佇列");
      }

      // 即時 UI 更新 (更新所有對應的文章按鈕圖示)
      const buttons = document.querySelectorAll(`[onclick*="handleToggleQueue('${id}')"]`);
      buttons.forEach(btn => {
        const i = btn.querySelector('i');
        if (i) {
          if (isRemoving) {
            i.className = 'fa-solid fa-plus text-[15px]';
            btn.title = '加入播放佇列';
          } else {
            i.className = 'fa-solid fa-minus text-[15px]';
            btn.title = '從佇列移除';
          }
        }
      });

      renderQueue();
      syncQueueToServer();
      applyPlayerDisplay();
    }

    function removeFromQueue(index) {
      allData.queue.splice(index, 1);
      renderQueue();
      syncQueueToServer();
      applyPlayerDisplay();
      renderArticles(); // 更新圖示
    }

    function playNextInQueue() {
      // 找到目前這首在佇列中的位置並移除
      const currentIdx = allData.queue.indexOf(currentPlayingId);
      if (currentIdx !== -1) {
        updateStarStatus(currentPlayingId, false);
        allData.queue.splice(currentIdx, 1);
        syncQueueToServer();
      }

      // 播放下一個位置的項目 (如果有的話)
      if (allData.queue.length > 0) {
        const nextA = allData.articles.find(it => it.id === allData.queue[0]);
        if (nextA) initPlayer(nextA, true);
        else { // 如果找不到文章，則跳過此 ID 繼續下一個
          allData.queue.shift();
          playNextInQueue();
        }
      } else {
        // 全部門聽完了，清除播放 ID
        currentPlayingId = null;
        applyPlayerDisplay();
        renderQueue();
        syncPlayerStateToCloud();
      }
    }

    function toggleQueuePanel() {
      document.getElementById('queue-panel').classList.toggle('show');
    }

    function renderQueue() {
      const list = document.getElementById('queue-article-list');
      const count = document.getElementById('queue-count');
      if (!list) return;

      count.innerText = allData.queue.length;
      list.innerHTML = '';

      if (allData.queue.length === 0) {
        list.innerHTML = '<div class="text-center py-10 text-slate-400 text-xs italic">目前佇列為空</div>';
        return;
      }

      // 將 ID 佇列轉換為物件佇列 (動態解析)
      const resolvedQueue = allData.queue
        .map(id => allData.articles.find(it => it.id === id))
        .filter(it => it != null);

      // 初始化或更新 Sortable
      if (list && !list._sortableInit) {
        new Sortable(list, {
          animation: 150,
          ghostClass: 'bg-blue-50',
          handle: '.queue-index',
          filter: '.active', // 禁止拖拽正在播放的項目
          onEnd: function (evt) {
            const oldIndex = evt.oldIndex;
            const newIndex = evt.newIndex;
            if (oldIndex === newIndex) return;

            // 根據 DOM 順序重新排列 allData.queue (ID 清單)
            const movedId = allData.queue.splice(oldIndex, 1)[0];
            allData.queue.splice(newIndex, 0, movedId);

            syncQueueToServer();
            renderQueue();
          }
        });
        list._sortableInit = true;
      }

      // 1. 渲染「正在播放」項目
      const activeIdx = resolvedQueue.findIndex(it => it.id === currentPlayingId);
      if (activeIdx !== -1) {
        const activeItem = resolvedQueue[activeIdx];
        const player = document.getElementById('main-audio-player');
        const isPaused = player ? player.paused : true;
        const iconClass = isPaused ? 'fa-circle-play' : 'fa-volume-high animate-pulse';

        const item = document.createElement('div');
        item.className = `queue-item active`;
        item.innerHTML = `
          <div onclick="event.stopPropagation(); togglePlayPause()" class="flex items-center justify-center w-8 h-8 text-blue-500 hover:bg-blue-50 rounded-full cursor-pointer transition-all shrink-0" title="${isPaused ? '繼續播放' : '暫停'}">
             <i class="fa-solid ${iconClass}"></i>
          </div>
          <div class="flex-1 min-w-0">
            <div class="text-[11px] font-bold line-clamp-1 text-blue-600" title="${activeItem.title}">${activeItem.title}</div>
            <div class="text-[9px] text-blue-400 flex items-center" title="${activeItem.source}">
              <span class="bg-blue-100 text-blue-600 px-1 rounded-[4px] mr-1 font-black transform scale-90">${isPaused ? '已暫停' : '正在播放'}</span>
              ${activeItem.source}
            </div>
          </div>
          <button onclick="event.stopPropagation(); removeFromQueueByElement('${activeItem.id}')" class="text-blue-300 hover:text-red-500 p-1 shrink-0">
            <i class="fa-solid fa-xmark text-xs"></i>
          </button>
        `;
        list.appendChild(item);
      }

      // 2. 渲染「等待播放」項目
      const upcoming = resolvedQueue.filter(it => it.id !== currentPlayingId);
      upcoming.forEach((a, idx) => {
        const item = document.createElement('div');
        item.className = `queue-item`;
        item.onclick = () => {
          initPlayer(a, true);
        };
        item.innerHTML = `
          <div class="queue-index flex items-center justify-center w-8 h-8 text-slate-300 cursor-grab active:cursor-grabbing hover:bg-slate-50 hover:text-slate-500 rounded-full transition-all flex-shrink-0" title="拖曳調整順序">
             <span class="text-[10px] font-bold">${idx + 1}</span>
          </div>
          <div class="flex-1 min-w-0">
            <div class="text-[11px] font-bold line-clamp-1" title="${a.title}">${a.title}</div>
            <div class="text-[9px] text-slate-400" title="${a.source}">${a.source}</div>
          </div>
          <button onclick="event.stopPropagation(); removeFromQueueByElement('${a.id}')" class="text-slate-300 hover:text-red-500 p-1">
            <i class="fa-solid fa-xmark text-xs"></i>
          </button>
        `;
        list.appendChild(item);
      });
    }

    function removeFromQueueByElement(id) {
      handleToggleQueue(id);
    }

    function stopPlayer() {
      const player = document.getElementById('main-audio-player');
      if (player) {
        player.pause();
        player.src = "";
        player.load();
      }
    }

    // 移除重複定義，已移至上方

    // [修正] 全局點擊監聽：點選外部時自動收合佇列與倍速選單
    document.addEventListener('click', (e) => {
      const queuePanel = document.getElementById('queue-panel');
      const speedMenu = document.getElementById('speed-menu');

      // 檢查點擊的是否是觸發按鈕或其子元素
      const isQueueToggle = e.target.closest('[onclick*="toggleQueuePanel"]');
      const isSpeedToggle = e.target.closest('[onclick*="toggleSpeedMenu"]') || e.target.closest('#speed-trigger');

      // 如果點擊的地方不在佇列面板內，也不是任何一個打開面板的按鈕，就收合
      if (queuePanel && queuePanel.classList.contains('show')) {
        if (!queuePanel.contains(e.target) && !isQueueToggle) {
          queuePanel.classList.remove('show');
        }
      }

      // 如果點擊的地方不在倍速選單內，也不是倍速觸發鈕，就收合
      if (speedMenu && speedMenu.classList.contains('show')) {
        if (!speedMenu.contains(e.target) && !isSpeedToggle) {
          speedMenu.classList.remove('show');
        }
      }
    });

    function formatDate(dateInput) {
      const date = new Date(dateInput);
      if (isNaN(date.getTime())) return '';
      return date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'numeric', day: 'numeric' });
    }

    /**
     * 開啟設定面板
     */
    /**
         * 開啟設定面板 (⚙️)
         * [修正] 優先讀取試算表回傳的設定 (allData.settings)，若無才讀取本地暫存
         */
    function showSettings() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 z-[400] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md animate-fade-in';
      modal.id = 'settings-modal';

      const currentUrl = localStorage.getItem('gas_web_app_url') || DEFAULT_GAS_URL;

      // [關鍵修正] 這裡增加了 allData.settings.GEMINI_API_KEY 的判斷
      // 確保優先顯示從資料表同步下來的金鑰
      const currentApiKey = (allData.settings && allData.settings.GEMINI_API_KEY)
        ? allData.settings.GEMINI_API_KEY
        : (localStorage.getItem('gemini_api_key') || "");

      modal.innerHTML = `
        <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] transform animate-pop-in">
          <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
            <h3 class="text-xl font-bold text-slate-800">系統連線設定</h3>
            <button onclick="this.closest('#settings-modal').remove()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-lg"></i></button>
          </div>
          <div class="p-8 overflow-y-auto space-y-6">
            <div>
              <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 ml-1">GAS Web App URL</label>
              <div class="relative">
                <i class="fa-solid fa-link absolute left-4 top-1/2 -translate-y-1/2 text-slate-300"></i>
                <input id="settings-gas-url" type="password" value="${currentUrl}" placeholder="https://script.google.com/..."
                  class="w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-2 focus:ring-blue-500/20 focus:bg-white transition-all">
              </div>
              <p class="text-[10px] text-slate-400 mt-2 ml-1">連結至您的 Google Apps Script 後端伺服器。</p>
            </div>

            <div>
              <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 ml-1">Gemini API Key (支援多金鑰輪替)</label>
              <div class="relative">
                <i class="fa-solid fa-key absolute left-4 top-4 text-slate-300"></i>
                <textarea id="settings-api-key" placeholder="貼上您的 Gemini API Key。支援多金鑰，請換行(Enter)輸入，一個失效會自動嘗試下一個。" rows="3"
                  class="w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-2xl text-[11px] font-mono outline-none focus:ring-2 focus:ring-blue-500/20 focus:bg-white transition-all">${currentApiKey}</textarea>
              </div>
              <p class="text-[10px] text-slate-400 mt-2 ml-1">建議每行貼上一組金鑰。系統會自動儲存至試算表的「系統設定」分頁以達成跨裝置同步。</p>
            </div>

            <div class="bg-blue-50/50 rounded-2xl p-5 border border-blue-100/50">
              <h4 class="text-xs font-bold text-blue-600 mb-3 flex items-center"><i class="fa-solid fa-share-nodes mr-2"></i> 分享目前設定</h4>
              <button onclick="handleGenerateShareLink()" id="share-btn" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold text-sm shadow-lg shadow-blue-100 hover:bg-blue-700 transition-all active:scale-95 mb-3">
                產生分享連結與 QR Code
              </button>
              
              <div id="share-result" class="hidden space-y-4 animate-fade-in">
                <div class="flex flex-col items-center">
                  <img id="share-qr" class="w-32 h-32 bg-white p-2 rounded-xl shadow-sm border border-slate-100 mb-2">
                  <span class="text-[10px] text-slate-400">掃描 QR Code 在手機開啟</span>
                </div>
                <div class="relative">
                  <input id="share-url-input" readonly class="w-full px-4 py-3 bg-white border border-slate-200 rounded-xl text-[10px] font-mono pr-20 outline-none">
                  <button onclick="copyShareUrl()" class="absolute right-2 top-1.5 px-3 py-1.5 bg-slate-100 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-200">複製</button>
                </div>
              </div>
            </div>

            <div class="flex gap-3 pt-4">
              <button onclick="handleClearSettings()" class="flex-1 py-3 bg-slate-100 text-slate-500 rounded-2xl font-bold text-sm hover:bg-red-50 hover:text-red-600 transition-all">
                清除設定
              </button>
              <button onclick="handleSaveSettingsInModal()" class="flex-[2] py-3 bg-blue-600 text-white rounded-2xl font-bold text-sm shadow-lg shadow-blue-100 hover:bg-blue-700 transition-all active:scale-95">
                儲存連線設定
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    async function handleSaveSettingsInModal() {
      const url = document.getElementById('settings-gas-url').value.trim();
      const apiKey = document.getElementById('settings-api-key').value.trim();

      if (url) localStorage.setItem('gas_web_app_url', url);
      else localStorage.removeItem('gas_web_app_url');

      if (apiKey) localStorage.setItem('gemini_api_key', apiKey);
      else localStorage.removeItem('gemini_api_key');

      // [核心更新] 同步 API Key 到試算表 (後端)
      if (apiKey && url) {
        showToast("同步設定至試算表中...", "info");
        try {
          await callApi('saveAppSettings', { GEMINI_API_KEY: apiKey });
          allData.settings.GEMINI_API_KEY = apiKey;
        } catch (e) {
          console.error("Failed to sync AI key to sheep", e);
        }
      }

      showToast("連線設定已儲存");
      document.getElementById('settings-modal').remove();
      refreshAll();
    }

    function handleClearSettings() {
      if (confirm("確定要清除所有連線設定嗎？這將會刪除儲存的 GAS URL 與 API Key。")) {
        localStorage.removeItem('gas_web_app_url');
        localStorage.removeItem('gemini_api_key');
        showToast("設定已清除", "success");
        setTimeout(() => window.location.reload(), 800);
      }
    }

    async function handleGenerateShareLink() {
      const url = document.getElementById('settings-gas-url').value.trim();
      if (!url) {
        showToast("請先輸入 GAS URL 再產生分享連結", "error");
        return;
      }

      const shareBtn = document.getElementById('share-btn');
      const shareIcon = shareBtn.querySelector('i') || {};
      const originalText = shareBtn.innerText;
      shareBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> 正在產生...';
      shareBtn.disabled = true;

      try {
        const base64Url = btoa(url);
        const longUrl = `${window.location.origin}${window.location.pathname}?config=${base64Url}`;

        // 使用 is.gd 縮短網址 (此處為示意，實際可用 fetch 呼叫 API)
        const shortenRes = await fetch(`https://is.gd/create.php?format=json&url=${encodeURIComponent(longUrl)}`);
        const shortenData = await shortenRes.json();
        const shortUrl = shortenData.shorturl || longUrl;

        document.getElementById('share-url-input').value = shortUrl;
        document.getElementById('share-qr').src = `https://quickchart.io/qr?text=${encodeURIComponent(shortUrl)}&size=200`;
        document.getElementById('share-result').classList.remove('hidden');
        showToast("分享連結已產生");
      } catch (e) {
        console.error("Generate share link failed", e);
        const base64Url = btoa(url);
        const longUrl = `${window.location.origin}${window.location.pathname}?config=${base64Url}`;
        document.getElementById('share-url-input').value = longUrl;
        document.getElementById('share-qr').src = `https://quickchart.io/qr?text=${encodeURIComponent(longUrl)}&size=200`;
        document.getElementById('share-result').classList.remove('hidden');
      } finally {
        shareBtn.innerHTML = originalText;
        shareBtn.disabled = false;
      }
    }

    /**
     * 開啟設定面板 (⚙️)
     */
    function showSettings() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 z-[400] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md animate-fade-in';
      modal.id = 'settings-modal';

      const currentUrl = localStorage.getItem('gas_web_app_url') || DEFAULT_GAS_URL;
      const currentApiKey = allData.settings.GEMINI_API_KEY || localStorage.getItem('gemini_api_key') || "";

      modal.innerHTML = `
        <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] transform animate-pop-in">
          <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
            <h3 class="text-xl font-bold text-slate-800">系統連線設定</h3>
            <button onclick="this.closest('#settings-modal').remove()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-lg"></i></button>
          </div>
          <div class="p-8 overflow-y-auto space-y-6">
            <!-- GAS URL Setting -->
            <div>
              <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 ml-1">GAS Web App URL</label>
              <div class="relative">
                <i class="fa-solid fa-link absolute left-4 top-1/2 -translate-y-1/2 text-slate-300"></i>
                <input id="settings-gas-url" type="password" value="${currentUrl}" placeholder="https://script.google.com/..."
                  class="w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-2 focus:ring-blue-500/20 focus:bg-white transition-all">
              </div>
              <p class="text-[10px] text-slate-400 mt-2 ml-1">連結至您的 Google Apps Script 後端伺服器。</p>
            </div>

            <!-- Gemini API Key Setting -->
            <div>
              <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 ml-1">Gemini API Key (支援多金鑰輪替)</label>
              <div class="relative">
                <i class="fa-solid fa-key absolute left-4 top-4 text-slate-300"></i>
                <textarea id="settings-api-key" placeholder="貼上您的 Gemini API Key。支援多金鑰，請換行(Enter)輸入，一個失效會自動嘗試下一個。" rows="3"
                  class="w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-2xl text-[11px] font-mono outline-none focus:ring-2 focus:ring-blue-500/20 focus:bg-white transition-all">${currentApiKey}</textarea>
              </div>
              <p class="text-[10px] text-slate-400 mt-2 ml-1">建議每行貼上一組金鑰。系統會自動儲存至試算表的「系統設定」分頁以達成跨裝置同步。</p>
            </div>

            <!-- Share Section -->
            <div class="bg-blue-50/50 rounded-2xl p-5 border border-blue-100/50">
              <h4 class="text-xs font-bold text-blue-600 mb-3 flex items-center"><i class="fa-solid fa-share-nodes mr-2"></i> 分享目前設定</h4>
              <button onclick="handleGenerateShareLink()" id="share-btn" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold text-sm shadow-lg shadow-blue-100 hover:bg-blue-700 transition-all active:scale-95 mb-3">
                產生分享連結與 QR Code
              </button>
              
              <div id="share-result" class="hidden space-y-4 animate-fade-in">
                <div class="flex flex-col items-center">
                  <img id="share-qr" class="w-32 h-32 bg-white p-2 rounded-xl shadow-sm border border-slate-100 mb-2">
                  <span class="text-[10px] text-slate-400">掃描 QR Code 在手機開啟</span>
                </div>
                <div class="relative">
                  <input id="share-url-input" readonly class="w-full px-4 py-3 bg-white border border-slate-200 rounded-xl text-[10px] font-mono pr-20 outline-none">
                  <button onclick="copyShareUrl()" class="absolute right-2 top-1.5 px-3 py-1.5 bg-slate-100 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-200">複製</button>
                </div>
              </div>
            </div>

            <div class="flex gap-3 pt-4">
              <button onclick="handleClearSettings()" class="flex-1 py-3 bg-slate-100 text-slate-500 rounded-2xl font-bold text-sm hover:bg-red-50 hover:text-red-600 transition-all">
                清除設定
              </button>
              <button onclick="handleSaveSettingsInModal()" class="flex-[2] py-3 bg-blue-600 text-white rounded-2xl font-bold text-sm shadow-lg shadow-blue-100 hover:bg-blue-700 transition-all active:scale-95">
                儲存連線設定
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function updateCategoryDropdown() {
      const selects = ['sub-category', 'batch-move-cat', 'edit-source-cat', 'import-target-category'];
      const categories = new Set(['未分類', 'Podcast', '科技', '新聞']);
      allData.subscriptions.forEach(s => {
        if (s.category) categories.add(s.category);
      });

      selects.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const currentVal = el.value;
        el.innerHTML = '';

        // 排序分類
        const sortedCats = Array.from(categories).sort();

        // 特別為匯入選項調整
        if (id === 'import-target-category') {
          const optNone = document.createElement('option');
          optNone.value = ""; optNone.innerText = "(依 OPML 分類)";
          el.appendChild(optNone);
        }

        sortedCats.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat;
          opt.innerText = cat;
          el.appendChild(opt);
        });

        const optNew = document.createElement('option');
        optNew.value = "NEW"; optNew.innerText = "-- 新增分類 --";
        el.appendChild(optNew);

        if (currentVal) el.value = currentVal;
      });
    }

    function checkNewCategory(select, wrapId) {
      const wrap = document.getElementById(wrapId);
      if (!wrap) return;
      if (select.value === 'NEW') {
        wrap.classList.remove('hidden');
      } else {
        wrap.classList.add('hidden');
      }
    }

    function getCategoryValue(selectId) {
      const select = document.getElementById(selectId);
      if (!select) return '未分類';
      if (select.value === 'NEW') {
        const customField = document.getElementById(selectId + '-custom');
        return customField ? (customField.value.trim() || '未分類') : '未分類';
      }
      return select.value;
    }

    /**
     * 開啟部署教學與原始碼
     */
    function showInstructions() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 z-[400] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md animate-fade-in';
      modal.id = 'instructions-modal';

      modal.innerHTML = `
        <div class="bg-white w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh] transform animate-pop-in">
          <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
            <h3 class="text-xl font-bold text-slate-800">部署與使用教學</h3>
            <button onclick="this.closest('#instructions-modal').remove()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-lg"></i></button>
          </div>
          <div class="p-8 overflow-y-auto space-y-6">
            <div class="space-y-4">
              <h4 class="font-bold text-blue-600 flex items-center"><i class="fa-solid fa-1 mr-2"></i> 建立 Google Apps Script</h4>
              <p class="text-sm text-slate-500">在 Google 試算表中，點擊「擴充功能」>「Apps Script」。</p>
              
              <h4 class="font-bold text-blue-600 flex items-center"><i class="fa-solid fa-2 mr-2"></i> 複製後端程式碼</h4>
              <div class="relative group">
                <button onclick="copyGasCode()" class="absolute right-4 top-4 bg-white/80 hover:bg-white text-slate-600 px-3 py-1.5 rounded-lg text-xs font-bold border border-slate-200 transition-all shadow-sm">
                   <i class="fa-solid fa-copy mr-1"></i> 複製程式碼
                </button>
                <div class="bg-slate-900 rounded-2xl p-6 text-[11px] font-mono text-slate-300 overflow-x-auto max-h-60 leading-relaxed shadow-inner">
                  <pre id="gas-code-preview">正在載入後端原始碼...</pre>
                </div>
              </div>

              <h4 class="font-bold text-blue-600 flex items-center"><i class="fa-solid fa-3 mr-2"></i> 部署為 Web App</h4>
              <ul class="text-sm text-slate-500 list-disc ml-5 space-y-2">
                <li>點擊右上方「部署」>「新增部署」。</li>
                <li>類型選擇「網頁應用程式」。</li>
                <li>執行身分：<b>我自己 (Me)</b>。</li>
                <li>誰可以存取：<b>任何人 (Anyone)</b>。</li>
                <li>完成後，<b>複製網頁應用程式 URL</b> 回到本網頁設定。</li>
              </ul>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // 載入完整的 GAS 原始碼
      fetchGasCode();
    }

    async function fetchGasCode() {
      // 這裡可以預留一個地方放 code，或是從外部載入
      // 為了方便使用者一鍵複製，我們可以把目前的 Code.gs 內容放在這裡
      const previewEl = document.getElementById('gas-code-preview');
      previewEl.innerText = `// [GAS 後端程式碼備份]\n// 此處原始碼應與您的 Code.gs 內容一致。\n// 部署後請務必將執行身分設為「我自己」，權限設為「任何人」。\n\n` +
        `// (由於檔案過大，建議直接從專案中的 Code.gs 檔案複製)`;
    }

    function copyGasCode() {
      // 實際應用中，這裡應包含完整的 Code.gs 字串內容
      showToast("建議直接從本專案的 Code.gs 檔案複製完整程式碼");
    }

    // --- AI Podcast Functions ---
    async function handleGenerateAI(id, btn) {
      const a = allData.articles.find(it => it.id === id);
      if (!a) return;

      const modal = document.getElementById('content-modal');
      if ((a.aiSummary || a.transcript) && modal.classList.contains('active')) {
        switchTab('summary');
        return;
      }

      if (a.aiSummary || a.transcript) {
        openFullContentModal(id);
        return;
      }

      btn.classList.add('active');
      btn.innerHTML = '<div class="loading-spinner"></div>';
      btn.disabled = true;

      try {
        const res = await callApi('processPodcastAI', { id });
        if (res.success) {
          a.aiSummary = res.summary;
          a.transcript = res.transcript;
          showToast("AI 生成完成！");
          resetAiButton(btn, true);
          openFullContentModal(id);
          applyPlayerDisplay();
        } else {
          if (res.error === "FILE_TOO_LARGE") {
            showAILargeFileModal(res.audioUrl, res.fileSizeMB);
          } else {
            showCustomModal("AI 處理失敗", res.message, "error");
          }
          resetAiButton(btn, false);
        }
      } catch (err) {
        console.error("AI Call Error:", err);
        resetAiButton(btn, false);
      }
    }

    function showAILargeFileModal(audioUrl, sizeMB) {
      document.getElementById('large-file-audio-link').href = audioUrl;
      const sizeEl = document.getElementById('large-file-size-text');
      if (sizeEl) {
        sizeEl.innerText = sizeMB ? `(${sizeMB} MB)` : '';
      }
      const modal = document.getElementById('ai-large-file-modal');
      modal.classList.remove('hidden');
      setTimeout(() => modal.classList.add('show'), 10);
    }

    function closeAILargeFileModal() {
      const modal = document.getElementById('ai-large-file-modal');
      modal.classList.remove('show');
      setTimeout(() => modal.classList.add('hidden'), 300);
    }

    function showAIFallbackModal(audioUrl) {
      // 設定下載連結
      const downloadLink = document.getElementById('ai-fallback-audio-download');
      if (downloadLink) {
        downloadLink.href = audioUrl;
      }

      callApi('getAIPodcastPrompt', { url: null }).then(prompt => {
        document.getElementById('ai-fallback-prompt-text').value = prompt;
        const modal = document.getElementById('ai-fallback-modal');
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.add('show'), 10);
      });
    }

    function closeAIFallbackModal() {
      const modal = document.getElementById('ai-fallback-modal');
      modal.classList.remove('show');
      setTimeout(() => modal.classList.add('hidden'), 300);
    }

    function copyAIPrompt() {
      const textarea = document.getElementById('ai-fallback-prompt-text');
      textarea.select();
      document.execCommand('copy');

      const btn = document.getElementById('copy-prompt-btn');
      const originalHtml = btn.innerHTML;
      btn.innerHTML = '<i class="fa-solid fa-check mr-2"></i> 已複製';
      btn.classList.replace('bg-blue-600', 'bg-green-600');

      setTimeout(() => {
        btn.innerHTML = originalHtml;
        btn.classList.replace('bg-green-600', 'bg-blue-600');
      }, 2000);

      showToast("提示詞已複製到剪貼簿");
    }

    function resetAiButton(btn, success) {
      btn.disabled = false;
      btn.style.width = '';
      btn.style.padding = '';
      btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles text-[15px]"></i>';
      btn.classList.remove('active');
      if (success) {
        btn.classList.remove('grayscale');
        btn.classList.add('grayscale-0', 'text-amber-500');
      }
    }

    function switchTab(tabName) {
      // 切換按鈕樣樣式 (Pill Toggle 版)
      document.querySelectorAll('.pill-toggle-btn').forEach(btn => {
        btn.classList.replace('active', 'inactive');
      });
      const targetBtn = document.getElementById('tab-' + tabName);
      if (targetBtn) {
        targetBtn.classList.replace('inactive', 'active');
      }

      // 切換內容顯示
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      const targetContent = document.getElementById('content-' + tabName);
      if (targetContent) {
        targetContent.classList.remove('hidden');
      }
    }

    // --- Pull to Refresh Logic ---
    function initPullToRefresh() {
      const container = document.getElementById('content-area');
      const ptr = document.getElementById('ptr-indicator');
      const icon = ptr.querySelector('i');

      let startY = 0;
      let currentY = 0;
      let isPulling = false;
      const threshold = 80;
      const maxPull = 120;

      container.addEventListener('touchstart', (e) => {
        if (container.scrollTop <= 0) {
          startY = e.touches[0].pageY;
          isPulling = true;
        }
      }, { passive: true });

      container.addEventListener('touchmove', (e) => {
        if (!isPulling) return;

        currentY = e.touches[0].pageY;
        const diff = currentY - startY;

        if (diff > 0 && container.scrollTop <= 0) {
          // Prevent default only if we are at the top and pulling down
          if (e.cancelable) e.preventDefault();

          const pullDistance = Math.min(diff * 0.5, maxPull);
          container.style.transform = `translateY(${pullDistance}px)`;

          ptr.classList.add('active', 'pulling');
          const rotation = Math.min(pullDistance / threshold * 180, 180);
          ptr.style.setProperty('--ptr-rotate', `${rotation}deg`);

          if (pullDistance >= threshold) {
            icon.className = 'fa-solid fa-arrow-up';
          } else {
            icon.className = 'fa-solid fa-arrow-down';
          }
        } else {
          isPulling = false;
          container.style.transform = '';
          ptr.classList.remove('active', 'pulling');
        }
      }, { passive: false });

      container.addEventListener('touchend', async () => {
        if (!isPulling) return;
        isPulling = false;

        const diff = currentY - startY;
        const pullDistance = Math.min(diff * 0.5, maxPull);

        if (pullDistance >= threshold) {
          ptr.classList.add('refreshing');
          icon.className = 'fa-solid fa-rotate';
          container.style.transform = `translateY(${threshold}px)`;

          try {
            await refreshAll();
          } finally {
            setTimeout(() => {
              container.style.transform = '';
              ptr.classList.remove('active', 'pulling', 'refreshing');
            }, 300);
          }
        } else {
          container.style.transform = '';
          ptr.classList.remove('active', 'pulling');
        }

        startY = 0;
        currentY = 0;
      });
    }

    // Initialize after DOM loaded or state ready
    window.addEventListener('load', () => {
      initPullToRefresh();
    });
  </script>

  <!-- Floating Ball -->
  <div id="podcast-floating-ball" onclick="togglePlayerDisplay('bar')">
    <div class="playing-anim"></div>
    <i class="fa-solid fa-microphone-lines text-xl"></i>
  </div>

  <!-- Podcast Player Bottom Bar -->
  <div id="podcast-player-bar" class="player-hidden">
    <!-- Queue Panel UI -->
    <div id="queue-panel">
      <div class="queue-header">
        <span class="text-xs font-bold uppercase tracking-widest text-slate-500">播放佇列 (<span
            id="queue-count">0</span>)</span>
        <button onclick="toggleQueuePanel()" class="text-slate-400 hover:text-slate-600"><i
            class="fa-solid fa-chevron-down"></i></button>
      </div>
      <div id="queue-article-list" class="queue-list"></div>
    </div>

    <div class="player-content overflow-visible">
      <audio id="main-audio-player"></audio>

      <!-- Info & Progress (Left) -->
      <div class="player-meta-group">
        <div class="player-info">
          <div class="player-title-wrap">
            <div class="player-title" id="player-item-title" onclick="openFullContentModal(currentPlayingId)">Podcast 標題
            </div>
          </div>
          <div id="player-item-subtitle" class="player-subtitle text-[10px] text-slate-400 truncate opacity-80"
            onclick="setSourceFilter(this.innerText)">來源名稱</div>
        </div>

        <div class="progress-container">
          <span id="player-current-time" class="time-display text-left">00:00</span>
          <div class="progress-bar-wrap" id="progress-wrap">
            <input type="range" id="player-progress" class="custom-progress" min="0" max="100" value="0">
            <div id="player-progress-fill" class="progress-fill"></div>
          </div>
          <span id="player-duration" class="time-display text-right">00:00</span>
        </div>
      </div>

      <div class="player-all-controls-group">
        <!-- Left Side (Mobile: Empty, Desktop: AI/Speed) -->
        <div class="player-controls-left flex items-center gap-2">
          <button id="player-ai-btn" onclick="handleGenerateAI(currentPlayingId, this)"
            class="ai-sparkle-btn w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 transition-all grayscale opacity-60"
            title="查看或生成 AI 筆記">
            <i class="fa-solid fa-wand-magic-sparkles text-sm"></i>
          </button>
          <div class="speed-menu-container relative">
            <button onclick="toggleSpeedMenu()" id="speed-trigger"
              class="px-2 h-7 flex items-center justify-center rounded-lg bg-slate-100 text-slate-600 font-bold text-[10px] hover:bg-slate-200 transition-all">1.0x</button>
            <div id="speed-menu">
              <div class="speed-menu-item active" onclick="setPlaybackSpeed(1.0)">1.0x</div>
              <div class="speed-menu-item" onclick="setPlaybackSpeed(1.25)">1.25x</div>
              <div class="speed-menu-item" onclick="setPlaybackSpeed(1.5)">1.5x</div>
              <div class="speed-menu-item" onclick="setPlaybackSpeed(2.0)">2.0x</div>
            </div>
          </div>
        </div>

        <!-- Middle (Main Controls - Centered in both) -->
        <div class="playback-main-group">
          <button onclick="skipTime(-15)" class="text-slate-400 hover:text-blue-600 transition-colors p-2"
            title="後退 15 秒">
            <i class="fa-solid fa-rotate-left"></i>
          </button>
          <button onclick="togglePlayPause()" id="player-main-btn" class="main-play-btn" title="播放/暫停">
            <i class="fa-solid fa-play ml-1"></i>
          </button>
          <button onclick="skipTime(30)" class="text-slate-400 hover:text-blue-600 transition-colors p-2"
            title="前進 30 秒">
            <i class="fa-solid fa-rotate-right"></i>
          </button>
        </div>

        <!-- Right Side (All secondary funcs on Mobile) -->
        <div class="player-controls-right flex items-center gap-2">
          <!-- AI & Speed (Moved here for Mobile single row) -->
          <button id="player-ai-btn-mobile" onclick="handleGenerateAI(currentPlayingId, this)"
            class="md:hidden ai-sparkle-btn w-8 h-8 flex items-center justify-center rounded-full text-slate-400"
            title="查看或生成 AI 筆記">
            <i class="fa-solid fa-wand-magic-sparkles text-sm"></i>
          </button>

          <button id="player-download-btn" onclick="handleDownload()"
            class="hidden lg:flex w-8 h-8 items-center justify-center rounded-full hover:bg-slate-100 text-slate-500 transition-all"
            title="下載音訊檔">
            <i class="fa-solid fa-download text-sm"></i>
          </button>

          <button onclick="toggleQueuePanel()"
            class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 text-slate-500 transition-all"
            title="播放佇列">
            <i class="fa-solid fa-list-ol text-sm"></i>
          </button>

          <button onclick="togglePlayerDisplay('ball')"
            class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 text-slate-400 hover:text-blue-500 transition-all"
            title="切換為懸浮球">
            <i class="fa-solid fa-down-left-and-up-right-to-center text-xs"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Large File Modal (放在 Body 結束前) -->
  <div id="ai-large-file-modal" class="fixed inset-0 z-[500] flex items-center justify-center p-4 hidden">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-md" onclick="closeAILargeFileModal()"></div>
    <div
      class="bg-white w-full max-w-sm rounded-3xl shadow-2xl relative p-6 transform transition-all duration-300 scale-95 opacity-0 modal-inner z-10 max-h-[90vh] overflow-y-auto">
      <div class="w-16 h-16 bg-amber-50 rounded-full flex items-center justify-center mx-auto mb-4 shrink-0">
        <i class="fa-solid fa-file-audio text-2xl text-amber-500"></i>
      </div>
      <h3 class="text-xl font-bold text-slate-800 text-center mb-2">音訊檔案過大</h3>
      <p class="text-sm text-slate-500 text-center mb-6 leading-relaxed">
        此 Podcast 音訊超過 45MB，受限於系統限制無法直接處理。<br>建議下載 MP3 後手動上傳至 <b>NotebookLM</b> 分析。
      </p>

      <div class="flex flex-col space-y-3">
        <a href="https://notebooklm.google.com/" target="_blank"
          class="flex items-center justify-center w-full px-6 py-4 bg-blue-600 text-white rounded-2xl font-bold text-base hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all active:scale-95">
          <i class="fa-solid fa-robot mr-3"></i> 前往 NotebookLM
        </a>
        <a id="large-file-audio-link" href="#" target="_blank" download
          class="flex items-center justify-center w-full px-6 py-4 bg-slate-100 text-slate-700 rounded-2xl font-bold text-base hover:bg-slate-200 transition-all active:scale-95">
          <i class="fa-solid fa-download mr-3"></i> 下載 MP3 檔案 <span id="large-file-size-text"
            class="ml-2 text-xs text-slate-400 font-normal"></span>
        </a>
        <button onclick="closeAILargeFileModal()"
          class="w-full py-3 text-slate-400 text-sm font-bold hover:text-slate-600 transition-colors">
          稍後再說
        </button>
      </div>
    </div>
  </div>

  <!-- AI Fallback Modal -->
  <div id="ai-fallback-modal" class="fixed inset-0 z-[500] flex items-center justify-center p-4 hidden">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-md" onclick="closeAIFallbackModal()"></div>
    <div
      class="bg-white w-full max-w-md rounded-3xl shadow-2xl relative p-6 transform transition-all duration-300 scale-95 opacity-0 modal-inner z-10 max-h-[90vh] overflow-y-auto">
      <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4 shrink-0">
        <i class="fa-solid fa-wand-magic-sparkles text-2xl text-blue-500"></i>
      </div>
      <h3 class="text-xl font-bold text-slate-800 text-center mb-2">手動 AI 處理指引</h3>
      <p class="text-xs text-slate-500 text-center mb-6 leading-relaxed">
        由於系統自動化失敗，請遵循以下步驟完成生成：<br>
        <b>1. 下載音訊</b> → <b>2. 上傳至 Gemini</b> → <b>3. 貼上提示詞</b>
      </p>

      <div class="mb-4">
        <a id="ai-fallback-audio-download" href="#" target="_blank" download
          class="flex items-center justify-center w-full px-6 py-4 bg-amber-50 text-amber-700 border border-amber-100 rounded-2xl font-bold text-base hover:bg-amber-100 transition-all active:scale-95">
          <i class="fa-solid fa-download mr-3"></i> 1. 第一步：下載音訊檔
        </a>
      </div>

      <div class="mb-6">
        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2 ml-1">2. 第二步：複製下方提示詞並貼上</label>
        <textarea id="ai-fallback-prompt-text" readonly
          class="w-full h-32 p-3 bg-slate-50 border border-slate-200 rounded-xl text-[11px] text-slate-600 focus:ring-0 outline-none resize-none font-mono"></textarea>
      </div>

      <div class="flex flex-col space-y-3">
        <button id="copy-prompt-btn" onclick="copyAIPrompt()"
          class="flex items-center justify-center w-full px-6 py-4 bg-blue-600 text-white rounded-2xl font-bold text-base hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all active:scale-95">
          <i class="fa-solid fa-copy mr-3"></i> 複製提示詞
        </button>
        <a href="https://gemini.google.com/app" target="_blank"
          class="flex items-center justify-center w-full px-6 py-4 bg-slate-100 text-slate-700 rounded-2xl font-bold text-base hover:bg-slate-200 transition-all active:scale-95">
          <i class="fa-solid fa-external-link mr-3"></i> 3. 前往 Gemini 網頁版
        </a>
        <button onclick="closeAIFallbackModal()"
          class="w-full py-3 text-slate-400 text-sm font-bold hover:text-slate-600 transition-colors">
          稍後再說
        </button>
      </div>
    </div>
  </div>

  <style>
    #ai-large-file-modal.show .modal-inner,
    #ai-fallback-modal.show .modal-inner {
      transform: scale(1);
      opacity: 1;
    }
  </style>
</body>

</html>